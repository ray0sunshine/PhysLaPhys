/*
NNNNNNNNNNNNNNNNNNNNNmhhymNNNNNNNNNNNNNNNNNNNNNNNdoooooooooooo+++++++++++ohhs+++++++++/++++++++++++++++++ohhhso+os+++++++++++++++++++++++++++++++++++++++++++++oyhhhsymNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN
NNNNNNNNNNNNNNNNNNNNNhhydNNNNNNNNNNNNNNNNNNNNNNmyosmdysoooooooo++++++++++shyo+++++++++/++++++++++++++++++oyhhyo++o+++++++++++++++++++++++sys++++++++++++++++++++oshhhysdNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN
NNNNNNNNNNNNNNNNNNNNdshymNNNNNNNNNNNNNNNNNNNNNmyoohNNNmmdhysoooo++/++s+++sho+++++++++//+++++++++++++++++++yhhyo+++++++++++++++++++++o++++ohyo+++++++oo++++++++++++oyhhhshmNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN
NNNNNNNNNNNNNNNNNNNNhhhdNNNNNNNNNNNNNNNNNNNNNdsooodNNNNNNNNmhyoo++++oo+++yyo+++++++++/++++++++++++++++++++shhy++++++++++++++++++++++so+++oyyo++++++ohhyo+++++++++++oshhhyymNNNNNNNNNNNNNNNNNNNNNNNNNNNNN
NNNNNNNNNNNNNNNNNNNmdhymNNNNNNNNNNNNNNNNNNNmhooooomNNNNNNNNmddhhs+++++++oys++++++++++/++++++++++++++++++++ohhy++++++++++++++++++++++++++++syo++++++oyhhs+++++++++++++oyhhyymNNNNNNNNNNNNNNNNNNNNNNNNNNNN
NNNNNNNNNNNNNNNNNNNNdhhmNNNNNNNNNNNNNNNNNNmyoooo+smNNNNNNNNmdddhho++++++oyo++++++++++/++++++++++/++++++++++yhs++++++++++++++++++++++++++++syo+++++++yhho++++++++++++++oyhhyymNNNNNNNNNNNNNNNNNNNNNNNNNNN
NNNNNNNNNNNNNNNNNNNmhydNNNNNNNNNNNNNNNNNNmy+osso+osdmNNNNNNmdddhy+++++++os++++++++++/:+++++++++//++++++++++oyo++++++++++++++++++++++++++++oyo+++++++shho+++++++++++++++oyhhysmNNNNNNNNNNNNNNNNNNNNNNNNNN
NNNNNNNNNNNNNNNNNNNdhdmNNNNNNNNNNNNNNNNNms+oyhs+++oosdmNNNNmddhhy+++++++++++++++++++///++++++++//+++++++++++o+++++++++++++++++++++++++++++++++++++++shyo++++++++++++++oysyhhyymNNNNNNNNNNNNNNNNNNNNNNNNN
NNNNNNNNNNNNNNNNNNNhydNNNNNNNNNNNNNNNNNms+oshyo++++oooydmNNmdhhhs++++++++++++++++++++o/++++++++//+++++++++++++++++++++++++++++++++++++++++++++++++++shy+++++++++++++++oyyoyhhsymNNNNNNNNNNNNNNNNNNNNNNNN
NNNNNNNNNNNNNNNNNNmhymNNNNNNNNNNNNNNNNms++ohho++++++ooddhdddhhhy+++++++++++++++++++/ss/++++++++//+++++++++++++++++++++++++++++++++++++++++++++++++++ohs+++//+++++++++++yhooyhhshNNNNNNNNNNNNNNNNNNNNNNNN
NNNNNNNNNNNNNNNNNmdydNNNNNNNNNNNNNNNNms+++shs++++++++omNmdhyyyhy++++/////++++++++++/yy/++++++++/:/+++/++++++++++++++++++++++/+++++++++++++++++++++++oyo+++//+/////+++++yho+shhhsdNNNNNNNNNNNNNNNNNNNNNNN
NNNNNNNNNNNNNNNNNmhymNNNNNNNNNNNNNNNmy++++oo+++++++++smNNNmhsoso/++/////////++++++++dd+++++++++/://++//++++++++++++++++++++//+/+++/+///+++++///////+oy+++////////////++yy++sshhysmNNNNNNNNNNNNNNNNNNNNNN
NNNNNNNNNNNNNNNNmhyymNNNNNNNNNNNNNNmy+++++++++/++++++ymNNNmdhys+//////////////+++++smms++++++++/::///////////////////////++////////////////////////+os+++//://////////+ss++++shhsymNNNNNNNNNNNNNNNNNNNNN
NNNNNNNNNNNNNNNNmyymNNNNNNNNNNNNNNmy++++++//////+++++hNNNNmhhhy+//////////////+++++yNmh+++++++//:://////////////////////////:///////////////////////oo+////:///////////+++/+++yhyohNNNNNNNNNNNNNNNNNNNNN
NNNNNNNNNNNNNNNNdyhNNNNNNNNNNNNNNNh+++++/////////++++dNNNNmhhhy+//////////////+++++dNNms+++++++/:///////////////////////////:///////////////////////++/////://///////////////+oyhsodNNNNNNNNNNNNNNNNNNNN
NNNNNNNNNNNNNNNmysdNNNNNNNNNNNNNNh+++++//////////////ohmNNmhhhy////////////////+++omNNNd+++++////+////://///////////////////://///////////////////////////://////////////////++ssooymNNNNNNNNNNNNNNNNNNN
NNNNNNNNNNNNNNNh+smNNNNNNNNNNNNNdo/++/////////////////+osddhyys///////////////++++smNNNmy++++////o+///://///////////////////://///////////////////////////:////////////////////+s+oodNNNNNNNNNNNNNNNNNNN
NNNNNNNNNNNNNNdo+hNNNNNNNNNNNNNmo/++//////////////////////+oyy+///////////////++++hNNNNNms++++///os///::///////////////////::///://///////////////////////://///////////////////oooosmNNNNNNNNNNNNNNNNNN
NNNNNNNNNNNNNmysymNNNNNNNNNNNNms/++////////////////://///////+////////////////++++dNNNNNNdo++++//oh///::///////////////////::///://///////////////////////:////////////////////:+ooyodNNNNNNNNNNNNNNNNNN
NNNNNNNNNNNNNhyyhmNNNNNNNNNNNmy////////////////////://///////::///////////////+++ommmdddddy+++++/+do//:////////////////////::///::///////////////////////::////////////////:///:/ooysyNNNNNNNNNNNNNNNNNN
NNNNNNNNNNNNmhyydNNNNNNNNNNNNd+////////////////////://////////:////////////////++smNmmmmddhy+/////hh///o///////////////////:////::///////////////////////:////////////////:://:://+yyomNNNNNNNNNNNNNNNNN
NNNNNNNNNNNNdysymNNNNNNNNNNNmo/////////////////////://///////::////////////////+/yNNNNNNNNNNho+//:/+:::y+///////////////////////::://///////////////////::///////////////::///:://+yyohNNNNNNNNNNNNNNNNN
NNNNNNNNNNNNhyymNNNNNNNNNNNmy/////////////////////:://///////::////////////////++dNNNNNNNNNNNdyo+/yo/::++:////////////////:+o///--://////////////////://:://////////////:-://:://:+yhsymNNNNNNNNNNNNNNNN
NNNNNNNNNNNmyhymNNNNNNNNNNNd+/////////////////////:://///////::////////////////++mNNNNNNNNNNNNNmdhmds////::://////////////:os///--://///////////////::/::///////////////--///:://:oyhysmNNNNNNNNNNNNNNNN
NNNNNNNNNNNhysdNNNNNNNNNNNms//////////////////////:://///////:://///////////////omNNNNNNNNNNNNNNNNNNms////:::::///////////:yy///--://///////////////::/:://////////////:-://::///:oyhyodNNNNNNNNNNNNNNNN
NNNNNNNNNNmyhymNNNNNNNNNNNh///////////////////////::////////:-://///////////////smNNNNNNNNNNNNNNNNNNNmy+///::::::://///////hd///:/:////////////////::/::://///////////::::/:::///:+yyyoyNNNNNNNNNNNNNNNN
NNNNNNNNNNdyydNNNNNNNNNNNmo///////////////////////-:////////:://////////////////ymNNNNNNNNNNmmmmmNNNNNmd+////:://:::///////dmo///o:////////////////::/:://///////////://:/:-:///::/yyhssmNNNNNNNNNNNNNNN
NNNNNNNNNmyysmNNNNNNNNNNmh///////////////////////:-:////////:://////////////////ymmmmmmmmmmmhyysssyyyhdddo////::://::::///ommy///s:///////////////::/:-://///////////:o:/:-:////-:/syhyomNNNNNNNNNNNNNNN
NNNNNNNNNhsyhNNNNNNNNNNmmo///////////////////////:-:////////:://////////::::::::syssoo+++/////////+++ossss+/////:::://::::smmd///h///////////////:-:/-://///////////:o/:::::///:-//oyyyodNNNNNNNNNNNNNNN
NNNNNNNNmyyodNNNNNNNNNNmy////////////////////////:-:///////:-:////////////////:/hdddddhhhyss++/:::-----:/oyy+:////:::://::odmmo/+h+/////////////:::::-:////////////:oo::--:///:-://+yyyohNNNNNNNNNNNNNNN
NNNNNNNNmsyymNNNNNNNNNNm+/////////////:::////////:-:///////:-://///////////::::/dmmNNNNNmmmmmddyyso+/::----:::::////:::::://hmdo+do////////////:+:::-:////////////:os:::--://::::///syyoyNNNNNNNNNNNNNNN
NNNNNNNNhyymNNNNNNNNNNmy///////::::::::::///////:::///////::-::////////////////omNNNNNNNNNmds++/////+osys+/:----://////::://omNmdmy://////////:so::-::///////////:oh/:::/::/::-::://oyyosmNNNNNNNNNNNNNN
NNNNNNNmyyhmNNNNNNNNNNm+///////::::::::::::::::::-:::::://:-::///::////////////+yyyymNNNNms++++++//osyydmmdhs+/:-:///////////dNNNms://////////yh/:--:///////////:sd+::/o:::::-:::://+yysomNNNNNNNNNNNNNN
NNNNNNNmyymNNNNNNNNNNmy///////:::::::////::/::/::-:::::::::-::::::::://////////smmmhydmNNdssssoo+////+symNNNmmdy+::://///////dNNNdsyo+//////+dm+::-::/://///:/:/ydo::/y/:/::-::/:://+yyyomNNNNNNNNNNNNNN
NNNNNNmhoymNNNNNNNNNNd+///////:-:::::::::::://:::-:::::::::-::::::::///////////ymNNNmhyddmdys+/:---:/+++odNNNNNmdoss+////////hNNmydNmdhso++ymmy/-:-::::::::::::+o+:--++::/:-:::::-://syy+dNNNNNNNNNNNNNN
NNNNNNdsydNNNNNNNNNNmy//////:/:-:::::::::::::::::-:::::::::-::::::::::::://////ymNNNNmmyosyso:------:oo+/smNNNNNNdodmh+//////hmdydmNNNNmmmmmms//:-::::::::--::///::/sy:::://:://::://oyy+dNNNNNNNNNNNNNN
NNNNNmhssmNNNNNNNNNNd+//////::-::::::::::::::::::-::::::::::::::::::::::///////hNNNNNNNmmhys+::------+ss+omNNNNNNNhdNmh+/////hdshmNNNNNNNNNms///:::::::::::://///+ydd+//:+yo:/:/::://+yy+dNNNNNNNNNNNNNN
NNNNmdoodNNNNNNNNNNmy///////::-::::::::::::::::::-::::::::-:::::::::::::///////dNNNNNNNNNNmmmdyso+//:+ssoymNNNNNNNNNNNmhoyo//ssdmNNNNNNNNmdo//////:::::://////+shmmmh+/+ymmo:////:-:/+yy+hNNNNNNNNNNNNNN
NNNNmyysdNNNNNNNNNNmo:////:::::::::::::::::::::::-::::::::-:::::::::::::///////dNNNNNNNNNNNNNNNNmmmdddhyyyhhhdddmNNNNmmmhdmyoymNNNNNNNNNmd+///////::::::///oydmmNNNNmmdmmmmo/////:-://syoymNNNNNNNNNNNNN
NNNNdyyhmNNNNNNNNNNd/////::::-::::::::::::::::::--::::::::-:::::::::::::://////dNNNNNNNNNNNNNNNNNNNNNNNNNmmmmmmmNNNmmmmmmNNdydNNNNNNNNNmh+////::::------:+ssyhmNNNNNNNNNNNmo/////::://oyosmNNNNNNNNNNNNN
NNNmhsymNNNNNNNNNNmy:////::::-::::::::::::::::::-:::::::::-:::::::::::::://////dNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmmmmmmmNNNNNmhdNNNNNNNmhoso+ss//+++///:---::/+shmNNNNNNNNNmo/////::://+ysomNNNNNNNNNNNNN
NNNmysymNNNNNNNNNNm+:////:::-:::::::::::::::::::-:::::::::-:::::::::::::://////dmNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmmNNNNNNmdohhhdssyso+///+syso+/:::/shdNNNNNNNmo//////:-:/+ysomNNNNNNNNNNNNN
NNmhsomNNNNNNNNNNmh/////::::-::::::::::::::::::::::::::::--:::::::::::::://////dNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmysmNmmds++/////::+hmdhhyo+/ohmNNNNNNm+/////::-://ssomNNNNNNNNNNNNN
NNmysymNNNNNNNNNNms:////:::-:::::::::::::::::::::::::::::--::::::::::::::://///dNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmhsmNNmyoo/----:::/ymNmmmddyssdmNNNNNd+////::::://ssomNNNNNNNNNNNNN
NNdsodNNNNNNNNNNmm+:///::::-:::::::::::::::::::::::::::::-::::::::::::::::////+dNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNdodmNdyy+-------:/odNNNNNmmddyydmmNmd/////::::-//osomNNNNNNNNNNNNN
NmysymNNNNNNNNNNmd/////:::--:::::::::::::::::::::::::::::-::::::::::::::::////+dNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmyhmmmdy+/:-----:o+smNNNNNNNmmhhhhdmd/////::::-:/+somNNNNNNNNNNNNN
NmyydNNNNNNNNNNNmy:////:::-::::::::::::::::::::::::::::::-::::::::::::::::////+mNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNdsdmNNmmdyo/:::+s+hmNNNNNmdyydhmmmmh/////::::-:/+somNNNNNNNNNNNNN
mdyymNNNNNNNNNNNm+:///::::-::::::::::::::::::::::::::::::-::::::::::::::::////+mmNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmhymNNNNNNmmhyooosdmmmddhyyhdmNNNNmy////::::::://oomNNNNNNNNNNNNN
dysdmNNNNNNNNNNmd/////:::-::::::::::::::::::::::::::::::--::::::::::::::::////+mmNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmyymNNNNNNNNNmmdhhhdhhddmmNNNNNNNmo:///::::::-//oomNNNNNNNNNNNNN
hysmNNNNNNNNNNNmy:///::::-::::::::::::::::::::::::::::::--::::::::::::::::////+mmNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmhhmNNNNNNNNNNNNNNNNNNNNNNNNNNNmh/://:::::::-:/++dNNNNNNNNNNNNN
hydNNNNNNNNNNNNmo:///:::--::::::::::::::::::::::::::::::--::::::::::::::::////+mmNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmyhmNNNNNNNNNNNNNNNNNNNNNNNNNmd+-:/::::::::-://+dNNNNNNNNNNNNN
dymNNNNNNNNNNNmd/////:::-:::::::::::::::::::::::::::::::--::::::::::::::::////+mNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNdsdNNNNNNNNNNNNNNNNNNNNNNNNmmo:-:/::::::::-://+dNNNNNNNNNNNNN
symNNNNNNNNNNNmy://:::::-:::::::::::::::::-:::::::::::::-:::::::::::::::::////omNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNdsymNNNNNNNNNNNNNNNNNNNNNNNmmh::-::::::::::::///dmNNNNNNNNNNNN
shNNNNNNNNNNNNmo:///:::-::::::::::::::::::-:::::::::::::-:::::::::::::::::////omNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmhshmNNNNNNNNNNNNNNNNNNNNNNNNmm+:--:::::::::::-///dmNNNNNNNNNNNN
hmNNNNNNNNNNNNd/://::::-::::::::::::::::::-:::::::::::::-:::::::::::::::::////omNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmmmmNNNNNNmdyhmNNNNNNNNNNNNNNNNNNNNNNNNNNms::--:::::::::::-///dmNNNNNNNNNNNN
dNNNNNNNNNNNNmh////:::--::::::::::::::::::-:::::::::::::-:::::::::::::::::////smNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmdyhdmNNNNmyymNNNNNNNNNNNNNNNNNNNNNNNNNNNNd/:---:::::::::::-://dNNNNNNNNNNNNN
mNNNNNNNNNNNNms://::::-::::::::::::::::::--:::::::::::::-::::::::::::::::::///smNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmshmNNNNNNNNNNNNNNNNNNNNNNNNNNNNmo::---:::::::::::-://dmNNNNNNNNNNNN
NNNNNNNNNNNNmm+://::::-::::::::::::::::::-::::::::::::::-:::::::::::::::::////smNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmyhmNNNNNNNNNNNNNNNNNNNNNNNNNNNNmy::----::::::::::::://dNNNNNNNNNNNNN
NNNNNNNNNNNNmd////:::--::::::::::::::::::-:::::::::::::--:::::::::::::::::////ymNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmd+:-----::::::::::::://dNNNNNNNNNNNNN
NNNNNNNNNNNNmy:///:::-::::::::::::::::::--:::::::::::::--:::::::::::::::::////ymNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmms::-----::::::::::::://dmNNNNNNNNNNNN
NNNNNNNNNNNmmo:///::--::::::::::::::::::--:::::::::::::--:::::::::::::::::////ymNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmh::------::::::::::::://dmNNNNNNNNNNNN
NNNNNNNNNNNmd////:::-:::::::::::::::::::-::::::::::::::--:::::::::::::::::////ymNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNm+:-------::::::::::::-:/dmNNNNNNNNNNNN
NNNNNNNNNNNmy:///:::-:::::::::::::::::::-::::::::::::::--:::::::::::::::::////ymNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNms::-------::::::::::::::/dmNNNNNNNNNNNN
NNNNNNNNNNmm+///:::-:::::::::::::::::::--::::::::::::::-::::::::::::::::::////ymNNNNNNNNNNNNNNNNNNNNNNNmmmmddhhhddhhhhhhddmNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmh/:--------:::::::::::/::/hmNNNNNNNNNNNN
NNNNNNNNNmmh////:::-:::::::::::::::::::-:::::::::::::::-::::::::::::::::::////smNNNNNNNNNNNNNNNNmmddhhhhhdddmmmmNNNmmmmmdhyyyhdmmmNNNNNNNNNNNNNNNNNNNNNNNNNNNNmd+:----------::::::::::/::/hNNNNNNNNNNNNN
NNNNNNNNNNmo:///::-:::::::::::::::::::--:::::::::::::::-::::::::::::::::::////smNNNNNNNNNNNNmdhhhhdmmmmmNNNNNNNNNNNNNNNNNNNmmdhyyyhdmNNNNNNNNNNNNNNNNNNNNNNNNNms:-----------::::::::::/:::hmNNNNNNNNNNNN
NNNNNNNNNNd/////::-:::::::::::::::::::.-:::::::::::::::-::::::::::::::::::////smNNNNNNNNNNNNmdmmmNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmmdhyhdmNNNNNNNNNNNNNNNNNNNNNmy::-----------:::::::::://::hmNNNNNNNNNNNN
NNNNNNNNNms:///::-:::::::::::::::::::-.-:::::::::::::::-::::::::::::::::::////smNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmdhhmNNNNNNNNNNNNNNNNNNNmh/:------------:::::::::://::ymNNNNNNNNNNNN
NNNNNNNNNm+://::--::::::::::::::::::-.-::::::::::::::::-::::::::::::::::::////smNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmdhmNNNNNNNNNNNNNNNNNmd/:-------------::::::::::///:ymNNNNNNNNNNNN
NNNNNNNNmh:///::-::::::::::::::::::--.-::::::::::::::::-::::::::::::::::::///:omNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmhhNNNNNNNNNNNNNNNNmh+:--------------::::::::::://:ymNNNNNNNNNNNN
NNNNNNNNmo://::-::::::::::::::::::----:::::::::::::::::-::::::::::::::::::///:omNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmhmNNNNNNNNNNNNNNmh/:---------------::::::::::://:ymNNNNNNNNNNNN
NNNNNNNmd////:--::::::::::::::::::.---:::::::::::::::::-::::::::::::::::::///:omNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmNNNNNNNNNNNNNNmy/:----------------::::::::::///:omNNNNNNNNNNNN
NNNNNNNmy://::-::::::::::::::::::----:::::::::::::::::--::::::::::::::::::://:omNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmdo::-----------------::::::::::://:+mmNNNNNNNNNNN
NNNNNNNmo///:-::::::::::::::::::-----:::::::::::::::::--::::::::::::::::::///:omNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmy/:-------------------:::::::::::////dmNNNNNNNNNNN
NNNNNNmh///:--:::::::::::::::::-----::::::::::::::::::--::::::::::::::::::://:omNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmh+::--------------------:::::::::::///:ymNNNNNNNNNNN
NNNNNNms://:-:::::::::::::::::-.----::::::::::::::::::--::::::::::::::::::://:/ydmNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmdo::----------------------:::::::::::://:omNNNNNNNNNNN
NNNNNNd+:/:-:::::::::::::::::-.----:::::::::::::::::::--::::::::::::::::::://:+ysydmNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmds/:--------------.---------:::::::::::://:+dNNNNNNNNNNN
NNNNNmh///-:::::::::::::::::-.----::::::::::::::::::::--::::::::::::::::::::/:+ddhyyhdmNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmds/:----------------.---------::::::::::::////dmNNNNNNNNNN
NNNNNmo:/:-::::::::::::::::-.---.-::::::::::::::::::::--::::::::::::::::::::/:+dddddhyyhmmNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmmds/:------------------.--------.::::::::::::///:hmNNNNNNNNNN
NNNNNd//:-::::::::::::::::-.-----:::::::::::::::::::::-:::::::::::::::::::://:odddmmmddyyydmmNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmmho/:--------------------.---------::::::::::::://:smNNNNNNNNNN
NNNNmy::-::::::::::::::::-.-----::::::::::::::::::::::-:::::::::::::::::::://:ommmmmmmmmdhyshdmNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmmho::----------------------.---------::::::::::::://:ommNNNNNNNNN
NNNmm+::-:::::::::::::::-.-----:::::::::::::::::::::::-:::::::::::::::::::://:omNNNNmmmmmmmdhyyhmmNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmdy+:----------.--------------..-------.::::::::::::://:/dmNNNNNNNNN
NNNmh/:-:::::::::::::::-.------::::::::::::::::::::::--:::::::::::::::::::////smNNNNNNNNNmmmmmdhyyhmmmNNNNNNNNNNNNNNNNNNNNNNNNNNNmmho/:------------..-------------..-------.:::::::::::::////dmNNNNNNNNN
NNNmo:-:::::::::::::::------.-::::::::::::::::::::::-.-::::::::::::::::::::///smNNNNNNNNNNNNNmmmmdhyyhdmmNNNNNNNNNNNNNNNNNNNNNNmmh+::--------------..--------------.-------.:::::::::::::///:hmNNNNNNNNN
NNmd/::::::::::::::::--------:::::::::::::::::::::::---::::::::::::::::::::://ymNNNNNNNNNNNNNNNNNmmmdhyyhdmNNNNNNNNNNNNNNNNNNmdyo+::--------------...--------------.--------:::::::::::::///:ymNNNNNNNNN
NNms:-::::::::::::::-.------:::::::::::::::::::::::----::::::::::::::::::::://smNNNNNNNNNNNNNNNNNNNNmmmdhysydmmNNNNNNNNNNNNmhsoydy:---------------...--------------.--------:::::::::::::///:smNNNNNNNNN
Nmd/-:/::::::::::::-.------:::::::::::::::::::::::-----:::::::::::::::::::::::/yhmmmNNNNNNNNNNNNNNNNNNNmmmmdysyhmmNNNNNNmmhsshdddy:---------------...--------------.-------.:::::::::::::///:ommNNNNNNNN
Nmy::/::::::::::::-.-------:::::::::::::::::::::::-----::::::::::::::::::::::::+++oshdmNNNNNNNNNNNNNNNNNNNmmmmdyyyydmmmdysyddmddds:---------------...--------------..------.::::::::::::::////dNNNNNNNNN
md+://:::::::::::-.-------:::::::::::::::::::::::------::::::::::::::::::::::::+++++++oshmmNNNNNNNNNNNNNNNNNNmmmmddyyssyhdmmmdddds:---------------....-------------..------.::::::::::::::////hmNNNNNNNN
my://:::::::::::-------.-:::::::::::::::::::::::-.-----::::::::::::::::::::::::+++++++++++ohmNNNNNNNNNNNNNNNNNNNmmmmmmmmmmmmmmddds:---------------.-..--------------.------.::::::::::::::///:ymNNNNNNNN
m+://::::::::::-.-----.-::::::::::::::::::::::::-------:::::::::::::::::::::::-++++++++++++++ydmNNNNNNNNNNNNNNNNNNmmmmmmmmmmmddddo----------------.--.--------------.------.::::::::::::::///:smNNNNNNNN
y:///:::::::::-.-----.-::::::::::::::::::::::::--------::::-:::::::::::::::::::/+++++++++++o+++sdNNNNNNNNNNNNNNNNNNNmmmmmmmmmddddo----------------.--.--------------.------.::::::::::::::///:omNNNNNNNN
+:///::::::::-------.-::::::::::::::::::::::::---------::::-::::::::::::::::::/hhso+++++++++++o++ymNNNNNNNNNNNNNNNNNNNmmmmmmmddddo----------------.--.--------------.------.::::::::::::::///:+mNNNNNNNN
://::::::::----------::::::::::::::::::::::::--------.-::::-::::::::::::::::://hmmmhs++++++++++o+++ymmNNNNNNNNNNNNNNNNNmmmddhysso:----------------.--.--------------..-----.:::::::::::::::///+dNNNNNNNN
:/::::::::-.--------:::::::::::::::::::::::::-------..-::::-::::::::::::::::///ymmmmmdyo++++++++++++odmNNNNNNNNNNNNNNNNmmy+/:::::-----------------..-..-------------..-----.:::::::::::::::////dNNNNNNNN
:::::::::--------.-:::::::::::::::::::::::::-------..--::::-::::::::::::::::///ymmmmmmmmho++++++++++++ymNNNNNNNNNNNNNNmh++++/::::-----------------..-..--------------.------:::::::::::::://///hmNNNNNNN
/:::::::----------:::::::::::::::::::::::::--------.---::::-::::::::::::::::///smmmmmmmmmmho++++++++++/smmNNNNNNNNNNNmy++++++/:::-----------------.---.--------------.------:::::::::::::::////hmNNNNNNN
hyso/:-----------:::::::::::::::::::::::::--------..---::::-:::::::::::::::////smmmmmmmmmmmmh+++++++++++odNNNNNNNNNNms++++++++/::-----------------.---.--------------.------:::::::::::::::///:ymNNNNNNN
hhhhhys+/-------:::::::::::::::::::::::::---------.----::::--::::::::::::::////smmmmmNmmNNmmmdy+++++++++/+dNNNNNNNNmh++o+++++++/:-----------------.---.--------------..-----:::::::::::::::///:ymmNNNNNN
hhhhhhhhhyo/:--:::::::::::::::::::::::::---------.-----::::--::::::::::::::////ommmNmmmNNNmmmmmdo+++++++++odmNNNNNNd++o++++++/oyy/----------------.---.--------------..-----::::::::::::-::///:smNNNNNNN
hhhhhhhhhhhhys+/::::::::::::::::::::::----------.------::::--::::::::::::::////ommmmNNNNNNNNNmmmmy++++++++++dmNNNNmy/oo++++++ymmms----------------..--..--------------.-----::::::::::::-::://:omNNNNNNN
yyhhhhhhhhhhhhhhyo/::::::::::::::::::----------..------::::--::::::::::::::////+mmmmNNNNNNNNNNmmmmh++++++++/+dmNNmm++o+++++odmmmms:---------------.----.--------------.----.::::::::::::-::://:+mNNNNNNN
ssooosyyhhhhhhdhhhhyo/::::::::::::::----------..-------:::::-::::::::::::::////+mmmmmmNNNNmmmmmmmmmdo+++++++/odmNmh/+o++++odmmmmmy:---------------.----.--------------..----::::::::::::-::://:+mNNNNNNN
shhhyssooossyhhhhhdhhhyo+:::::::::-----------..-------.-::::-::::::::::::::////+dmmmNNNNNNmmNmmNNmmmdo+++++++/smmms/++oo++dmmmmmmh:---------------..---.---------------.----::::::::::::-::://:/dNNNNNNN
+ohhhoyhhyyso+oosyhhhhhhhyo+/::::------------.--------.-::::-:::::::::::::://///dmmmmNNNNmmmNNNNmmmmmd++++++++/ymm++++o+/hmmmmmmmh::--------------..---..--------------.----:::::::::::::-::////dNNNNNNN
s/yhhs+shhhhhyoooooosyhhhhhhys+/------------.---------.-::::--::::::::::::://///hmmmmmmNNNmNNNNNmmmmmmh+++++++//hd/+++++ommmNmmmmh/:--------------..---..--------------..---:::::::::::::-::////hmNNNNNN
o/shhhs/ohhhhhs+oshyyo++oyyhhhhyyo+/::-----.------------::::--::::::::::::://///hmmmmNNNNNmNNNNmNNNmmmmy/++++++/+y/++++/ymmmmmmmmd/::-------------..----.--------------..---:::::::::::::-::////hmNNNNNN
+:/hhhho:+yhhhhs/+oyhhyoossosyyhhhhhyyso+/:-------------::::--::::::::::::::////ymmmmNNNNNNNNNNNNNNNmmmm+/++++++://+++++dmmmmmmmmdoo/--------------.----.---------------.---:::::::::::::-::://:ymNNNNNN
y/:shhhh+:+shhhhy+//shhysyhsoooosyhhhhhhhhyyssoo+//:::--::::--::::::::::::::////smmmmmmNNNNNNNNmNNmmmmmmh/++++++/-/++++ommmmmmNmmmsdho:------------.----.---------------.---:::::::::::::-::://:smNNNNNN
hy//hhhhy//+shhhhh+//oyhyoyhyoosysoosyhhhhhhhhhhhhhhhyo-:::::-::::::::::::::////ommNmmmNNNNNNNNmmmmmmmmmms/++++++:/+++/smmmmmmmmmmshmmho:----------.----..--------------..-.:::::::::::::-::::/:omNNNNNN
hhy/ohhhhs:++ohhhhho//+shsosyhs+oyhs//osyyhhhhhhhhhhhhy::::::-::::::::::::::////ommmNNmNNNNNNNNmNmmNNmmmmd++++++++++++/ymmmmmmmmmmyydmmmho:--------.-----.--------------..-.:::::::::::::-::::/:+mmNmmmd
hhhy/shhhh+/o++yhhhhs/+/oyhsooyhyooyy/syysssyyhhhhhhhhy::::::-::::::::::::::////+mmmNNNNNNNNNNNmNmmNNNNmmmy/++++++++++/hmmmmmmmmmmhoyhhddmho:------.-----.---------------.-.:::::::::::::--:::::/dmhysss
hhhhs/yhhhy/+oo+shhhhy++++yhhs+oyhs+os+shhhhysssssyyyyy::::::--::::::::::::://///dmNNNNNNNNNNNNmNmmNmmmmmmd+/++++++++++hmmmmmmmmmmd+yyyyyhhdds/:-------------------------..-::::::::::::::-:::::/y++ssss
hhdhho+hhhhs/oso++yhhhy++++ohhhyooyhs+++oyhhhhhhhhyyyso::::::--::::::::::::::////dmmmmNNNNNNNNNmmmmNmmmmmmmy/++++++++++hmmmmmmmmmmmosyyyyyyyyhdho/:----------------------..-::::::::::::::-:::://+oossyy
+hddhhoohhhh++ssso+yhhhho+o++yhhhs+shyo+++ohhhdhhhhhhhy::::::--::::::::::::::////hmmmmmmNNNNNNNmmmmNNNmmmmmd++++++++++/ymmmmmmmmmmmyoyyyyyyyyyyhddhyo/::------------------.-::::::::::::::-osyhhhhhhhhhh
yoyhddh+ohhhy/ossss+ohhhho+oo/ohhhhsoyhy++o+shhhhhhhhhh/:::::--::::::::::::::///:ymmmmmmNNNNNNNmmmmNNNNNNmmms/++++++++/ommmmmmmmmmmd+yyyyyyyyyyyyhmmmmdyo+::--------------.-:::::::::::::::yhhhhhhhhhhhh
mdssyyssyosys+ssoooo++yhhhs+oo++shhhyooyhs+oo+shhhhhhhh+::::::-::::::::::::::://:ommmmmmmmmmmmmmNmmmmmmmmmmmh/++++++++++dmmmmmmmmmmm+syyyyyyyyyyyhmmmmmmmmdys+/:::--------.-:::::::::::::::shhhhhhhyyyyy
mmmdhhdmmmmddmmmmddhyyosyhhs+sso+oyhhhs+shy++yo+yhhhhhho::::::--:::::::::::::://:/syyhdmmmmmmmmNNmmmmmmmmmmmmo/++++++++/hmmmmmmmmmmmsshhyyyyyyyyyhmmmmmmmmmmmmmdyso+/:::----::::::::::::::-/oo++/+ooooss
mmmmmmmmmmmmmmmmmmmmmmmdysss+oooso+ohhhhooyhs+syo+yhhhho::::::--:::::::::::::://:+dmddhyssyhddmmmmmmmmmmmmmmmy/++++++++/smmmmmmmmmmmdsmmmdhyyyyyydmmmmmmmmmmmmmmmmmmmddho:--:::::::::::::::/yhhy+yhhhhhh
mmmmmmmmmNNNNNNmmmmmmNmmmmddmmdhyso//shhhs+yhy+oyy+ohhhs::::::--::::::::::::::////dmmmmmmmdhyyssyhdmmmmmmmmmmd//+++++++++mmmmmmmmmmmmsdmmmmdhyyyhmmmmmmNNNmmmNmmmmmmmmmm+:--:::::::::::::::/hhh+shhhhhhy
NNNNNNNmmNNNNNNNNmmmmmNNNmmmmmmmmmmdysssyhy+shho+yhs+shy::::::--::::::::::::::////dmmmNmmmmmmmmmmhhyysyhdmmmmm+/++++++++/dmmmmmmmmmmmhymmmmmdhhhmmmmNNNNNNmmmmmmmmmmmdmd/:--::::::::::::::::yhs+hhhhhhhs
SATSUKI SAMA!!!!!
*/

#ifndef TERRAIN_HPP
#define TERRAIN_HPP
#include <GL/gl.h>
#include <GL/glu.h>
#include <sstream>
#include <algorithm>
#include <iostream>
#include <fstream>
#include <string>
#include <vector>

#define def_dim 40
#define tile_dim 30

struct vct{
	double x,y,z;
};

struct shpt{
	double x;
	double z;
	double dark;
};

struct tpt{
	double x,z;
	double u,v;
	vct norm;	//normal
	double height;	//relative to y=0
};

int grDim = def_dim;
GLuint terrainTex = 0;
tpt ground[def_dim][def_dim];

double fRand(double fMin, double fMax){
    double f=(double)rand()/RAND_MAX;
    return fMin + f*(fMax-fMin);
}

double heightFunc(double x, double z){
	return fRand(-2,2);
}

vct calcNorm(vct a, vct b){
	vct ret;
	ret.x = a.y*b.z-a.z*b.y;
	ret.y = a.z*b.x-a.x*b.z;
	ret.z = a.x*b.y-a.y*b.x;
	double len = sqrt(ret.x*ret.x + ret.y*ret.y + ret.z*ret.z);
	ret.x /= len;
	ret.y /= len;
	ret.z /= len;
	return ret;
}

GLuint LoadRawTerrainTex(const char* fname, int width, int height){
    FILE* f = fopen(fname, "rb");
    if(f == NULL){
    	return 0;
    }
    unsigned char* data = (unsigned char*)malloc(width * height * 3);
    fread(data, width * height * 3, 1, f);
    fclose(f);

    GLuint texture;
    glGenTextures(1, &texture);
    glBindTexture(GL_TEXTURE_2D, texture);
    glTexEnvf(GL_TEXTURE_ENV, GL_TEXTURE_ENV_MODE, GL_MODULATE);
    glTexParameterf(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR_MIPMAP_NEAREST);
    glTexParameterf(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
    glTexParameterf(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP);
    glTexParameterf(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_CLAMP);
    gluBuild2DMipmaps(GL_TEXTURE_2D, 3, width, height, GL_BGR, GL_UNSIGNED_BYTE, data);
    free(data);
    return texture;
}

//generate the square grid of tpts
void initGround(){
	for(int i=0; i<def_dim; i++){
		for(int j=0; j<def_dim; j++){
			ground[i][j].x = -(tile_dim*def_dim)/2 + i*tile_dim;
			ground[i][j].z = -(tile_dim*def_dim)/2 + j*tile_dim;

			ground[i][j].u = (0.5 + (double)i)/def_dim;
			ground[i][j].v = (0.5 + (double)j)/def_dim;

			ground[i][j].height = heightFunc(ground[i][j].x, ground[i][j].z);
			
			ground[i][j].norm.x = 0;
			ground[i][j].norm.y = 0;
			ground[i][j].norm.z = 0;
		}
	}

	//calc normals
	for(int i=1; i<def_dim-1; i++){
		for(int j=1; j<def_dim-1; j++){
			vct a,b;
			a.x = def_dim;
			a.y = ground[i+1][j].height - ground[i-1][j].height;
			a.z = 0;

			b.x = 0;
			b.y = ground[i][j+1].height - ground[i][j-1].height;
			b.z = def_dim;

			ground[i][j].norm = calcNorm(b,a);
		}
	}
}

int waterx = 20;
int waterz = 20;

#define def_depth 5
#define flow_damp 0.99
#define flow_acc_damp 0.01

struct wcol{
	double x;
	double z;
	double v;	//volume of water contained
	double sv;	//solid volume when object in water
	vct norm;
};

struct wcon{
	double flow;
	int ax, az;
	int bx, bz;
};

std::vector<wcon> cons;
wcol columns[tile_dim+1][tile_dim+1];
bool waveTrans = true;
#define waveNormThres 0.8

bool shading = true;

void drawGround(){
	glEnable(GL_TEXTURE_2D);
    glBindTexture(GL_TEXTURE_2D, terrainTex);
    glBegin(GL_QUADS);
    glColor3f(1,1,1);
    if(shading){
	    for(int i=1; i<def_dim; i++){
			for(int j=1; j<def_dim; j++){
				if(i != waterx || j != waterz){
					tpt g1 = ground[i-1][j-1];
					tpt g2 = ground[i][j-1];
					tpt g3 = ground[i][j];
					tpt g4 = ground[i-1][j];
					glTexCoord2d(g1.u,g1.v); glNormal3d(g1.norm.x,g1.norm.y,g1.norm.z); glVertex3d(g1.x,0,g1.z);
					glTexCoord2d(g2.u,g2.v); glNormal3d(g2.norm.x,g2.norm.y,g2.norm.z); glVertex3d(g2.x,0,g2.z);
					glTexCoord2d(g3.u,g3.v); glNormal3d(g3.norm.x,g3.norm.y,g3.norm.z); glVertex3d(g3.x,0,g3.z);
					glTexCoord2d(g4.u,g4.v); glNormal3d(g4.norm.x,g4.norm.y,g4.norm.z); glVertex3d(g4.x,0,g4.z);
				}
			}
		}
	}else{
		for(int i=1; i<def_dim; i++){
			for(int j=1; j<def_dim; j++){
				if(i != waterx || j != waterz){
					tpt g1 = ground[i-1][j-1];
					tpt g2 = ground[i][j-1];
					tpt g3 = ground[i][j];
					tpt g4 = ground[i-1][j];
					glTexCoord2d(g1.u,g1.v); glNormal3d(g1.norm.x,g1.norm.y,g1.norm.z); glVertex3d(g1.x,g1.height,g1.z);
					glTexCoord2d(g2.u,g2.v); glNormal3d(g2.norm.x,g2.norm.y,g2.norm.z); glVertex3d(g2.x,g2.height,g2.z);
					glTexCoord2d(g3.u,g3.v); glNormal3d(g3.norm.x,g3.norm.y,g3.norm.z); glVertex3d(g3.x,g3.height,g3.z);
					glTexCoord2d(g4.u,g4.v); glNormal3d(g4.norm.x,g4.norm.y,g4.norm.z); glVertex3d(g4.x,g4.height,g4.z);
				}
			}
		}
	}
    glEnd();
}

void initWater(){
	for(int i=0; i<tile_dim+1; i++){
		for(int j=0; j<tile_dim+1; j++){
			columns[i][j].v = def_depth;
			columns[i][j].sv = fRand(-0.2,0.2);
			columns[i][j].x = (waterx-1)*tile_dim - (tile_dim*def_dim)/2 + i;
			columns[i][j].z = (waterz-1)*tile_dim - (tile_dim*def_dim)/2 + j;
		}
	}

	for(int i=0; i<tile_dim+1; i++){
		for(int j=0; j<tile_dim; j++){
			wcon nc;
			nc.ax = j;
			nc.az = i;
			nc.bx = j+1;
			nc.bz = i;
			nc.flow = 0;
			cons.push_back(nc);
		}
	}

	for(int i=0; i<tile_dim+1; i++){
		for(int j=0; j<tile_dim; j++){
			wcon nc;
			nc.ax = i;
			nc.az = j;
			nc.bx = i;
			nc.bz = j+1;
			nc.flow = 0;
			cons.push_back(nc);
		}
	}
};

void simWater(double charx, double charz){
	for(int i=0; i<tile_dim+1; i++){
		for(int j=0; j<tile_dim+1; j++){
			columns[i][j].x = (waterx-1)*tile_dim - (tile_dim*def_dim)/2 + i;
			columns[i][j].z = (waterz-1)*tile_dim - (tile_dim*def_dim)/2 + j;
		}
	}

	double ccx = charx - columns[0][0].x;
	double ccz = charz - columns[0][0].z;

	//std::cout << ccx << " , " << ccz << "\n";
	if(ccx > 0 && ccz > 0){
		for(int i=1; i<tile_dim; i++){
			for(int j=1; j<tile_dim; j++){
				columns[i][j].sv = 0;
			}
		}
		int i = ccx;
		int j = ccz;
		if(i >= 0 && i < tile_dim && j >= 0 && j < tile_dim){
			columns[i][j].sv = 1;
			columns[i+1][j].sv = 1;
			columns[i][j+1].sv = 1;
			columns[i+1][j+1].sv = 1;
		}
	}

	for(int i=0; i<cons.size(); i++){
		wcol ca = columns[cons[i].ax][cons[i].az];
		wcol cb = columns[cons[i].bx][cons[i].bz];
		cons[i].flow += ((ca.v + ca.sv) - (cb.v + cb.sv))*flow_acc_damp;
		cons[i].flow *= flow_damp;
	}

	for(int i=0; i<cons.size(); i++){
		wcon fl = cons[i];
		columns[fl.ax][fl.az].v -= fl.flow;
		columns[fl.bx][fl.bz].v += fl.flow;
	}

	/*waveTrans = true;*/
	for(int i=1; i<tile_dim; i++){
		for(int j=1; j<tile_dim; j++){
			vct a,b;
			a.x = 2;
			a.y = (columns[i+1][j].v + columns[i+1][j].sv) - (columns[i-1][j].v + columns[i-1][j].sv);
			a.z = 0;

			b.x = 0;
			b.y = (columns[i][j+1].v + columns[i][j+1].sv) - (columns[i][j-1].v + columns[i][j-1].sv);
			b.z = 2;

			columns[i][j].norm = calcNorm(b,a);
			/*if(columns[i][j].norm.y < waveNormThres){
				waveTrans = false;
			}*/
		}
	}
}

void drawWater(double charx, double charz){
	simWater(charx,charz);
	glDisable(GL_TEXTURE_2D);
    glBegin(GL_QUADS);
    if(waveTrans){
    	glColor4f(0.2,0.2,0.6,0.5);
    }else{
    	glColor3f(0.2,0.2,0.6);
    }
    
    for(int i=1; i<tile_dim+1; i++){
		for(int j=1; j<tile_dim+1; j++){
			wcol w1 = columns[i-1][j-1];
			wcol w2 = columns[i][j-1];
			wcol w3 = columns[i][j];
			wcol w4 = columns[i-1][j];
			glNormal3d(w1.norm.x, w1.norm.y, w1.norm.z); glVertex3d(w1.x, w1.sv + w1.v - def_depth, w1.z);
			glNormal3d(w2.norm.x, w2.norm.y, w2.norm.z); glVertex3d(w2.x, w2.sv + w2.v - def_depth, w2.z);
			glNormal3d(w3.norm.x, w3.norm.y, w3.norm.z); glVertex3d(w3.x, w3.sv + w3.v - def_depth, w3.z);
			glNormal3d(w4.norm.x, w4.norm.y, w4.norm.z); glVertex3d(w4.x, w4.sv + w4.v - def_depth, w4.z);
		}
	}
    glEnd();
}

#define sh_dim 100
#define sh_seg 0.8
#define sh_cast 45
shpt shade[sh_dim][sh_dim];

void shiftShade(double dx, double dz){
	for(int i=0; i<sh_dim; i++){
		for(int j=0; j<sh_dim; j++){
			shade[i][j].x += dx;
			shade[i][j].z += dz;
		}
	}
}

void initShade(){
	double hdim = (sh_dim*sh_seg)/2;
	for(int i=0; i<sh_dim; i++){
  		for(int j=0; j<sh_dim; j++){
  			shade[i][j].x = i*sh_seg - hdim;
  			shade[i][j].z = j*sh_seg - hdim;
  		}
  	}
}

void shadow(std::vector<vct> mps, double lx, double ly, double lz, double charx, double charz){
	glDisable(GL_TEXTURE_2D);
  	glBegin(GL_QUADS);
  	glNormal3d(0,1,0);
  	for(int i=0; i<sh_dim; i++){
  		for(int j=0; j<sh_dim; j++){
  			shade[i][j].dark = 0;
  		}
  	}

  	double hdim = (sh_dim*sh_seg)/2;

  	//calculate darkness values based on shadow propagation
  	for(int i=0; i<mps.size(); i++){
  		vct mp = mps[i];

  		if(mp.y > 0){
	  		//calculate normalized vector from light to mps[i]
	  		vct tp;
	  		tp.x = mp.x - lx;
	  		tp.y = mp.y - ly;
	  		tp.z = mp.z - lz;

	  		double tplen = sqrt(tp.x*tp.x + tp.y*tp.y + tp.z*tp.z);
	  		tp.x /= tplen;
	  		tp.y /= tplen;
	  		tp.z /= tplen;

		  	//calculate extension from mps[i] along length sh_cast
	  		vct shcast;
	  		double prpx = tp.x*sh_cast;
	  		double prpy = tp.y*sh_cast;
	  		double prpz = tp.z*sh_cast;

	  		shcast.x = mp.x + prpx;
	  		shcast.y = mp.y + prpy;
	  		shcast.z = mp.z + prpz;

		  	//if result has negative y, calculate x,z at y=0
	  		if(shcast.y < 0){
	  			//if x,z hashes to a point within shadow grid, calculate x,z dist to mps[i] and get strength of shadow
	  			double shadeStr = -shcast.y/(mp.y-shcast.y);
	  			double propaLen = 1-shadeStr;
	  			double cx = mp.x + prpx*propaLen;
	  			double cz = mp.z + prpz*propaLen;

	  			int xgf = floor((cx - charx + hdim)/sh_seg);
	  			int xgc = ceil((cx - charx + hdim)/sh_seg);
	  			int zgf = floor((cz - charz + hdim)/sh_seg);
	  			int zgc = ceil((cz - charz + hdim)/sh_seg);
	  			if(xgf < sh_dim && zgf < sh_dim){
	  				if(shade[xgf][zgf].dark < shadeStr){
	  					shade[xgf][zgf].dark = shadeStr;
	  				}
	  			}

	  			if(xgf < sh_dim && zgc < sh_dim){
	  				if(shade[xgf][zgc].dark < shadeStr){
	  					shade[xgf][zgc].dark = shadeStr;
	  				}
	  			}

	  			if(xgc < sh_dim && zgc < sh_dim){
	  				if(shade[xgc][zgc].dark < shadeStr){
	  					shade[xgc][zgc].dark = shadeStr;
	  				}
	  			}

	  			if(xgc < sh_dim && zgf < sh_dim){
	  				if(shade[xgc][zgf].dark < shadeStr){
	  					shade[xgc][zgf].dark = shadeStr;
	  				}
	  			}
	  		}
	  	}
  	}

  	//blend shade base on dist from origin
  	double blend[sh_dim][sh_dim];
  	for(int b=0; b<2; b++){
	  	for(int i=1; i<sh_dim-1; i++){
		    for(int j=1; j<sh_dim-1; j++){
		      	blend[i][j] =  shade[i][j].dark*0.3+
		                       shade[i+1][j].dark*0.1+
		                       shade[i][j+1].dark*0.1+
		                       shade[i-1][j].dark*0.1+
		                       shade[i][j-1].dark*0.1+
		                       shade[i+1][j+1].dark*0.075+
		                       shade[i+1][j-1].dark*0.075+
		                       shade[i-1][j-1].dark*0.075+
		                       shade[i-1][j+1].dark*0.075;
		    }
		}

		for(int i=1; i<sh_dim-1; i++){
		    for(int j=1; j<sh_dim-1; j++){
		    	shade[i][j].dark = blend[i][j];
		    }
		}
	}

	if(shading){
	  	for(int i=0; i<sh_dim-1; i++){
	  		for(int j=0; j<sh_dim-1; j++){
	  			shpt sh1 = shade[i][j];
	  			shpt sh2 = shade[i+1][j];
	  			shpt sh3 = shade[i+1][j+1];
	  			shpt sh4 = shade[i][j+1];
	  			if(sh1.dark > 0 || sh2.dark > 0 || sh3.dark > 0 || sh4.dark > 0){
	  				glColor4f(0,0,0,sh1.dark); glVertex3d(sh1.x,0.1,sh1.z);
		      		glColor4f(0,0,0,sh2.dark); glVertex3d(sh2.x,0.1,sh2.z);
		      		glColor4f(0,0,0,sh3.dark); glVertex3d(sh3.x,0.1,sh3.z);
		      		glColor4f(0,0,0,sh4.dark); glVertex3d(sh4.x,0.1,sh4.z);
	  			}
	  		}
	  	}
	}

	glEnd();
}

#endif