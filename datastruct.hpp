/*
-------------................------:/++ooosyyhddmmmNNNNNNNNNNNNNNNNNNNNNNmmmmddhyooy/-...-oy+++++/////////////////////////////////////////////////++so-........-/so++ooo++++o+/:::/+oooooooooooooooo++++
++++++++++++++++++++//////////::::::///+++ooossyyhddmmNNNNNNNNNNNNNNNNNNNmmmmddhysooy+--.-oy+++///////////////////////////////////////////////////+ss-........-os+++ooooooo+++++/:--:+oooooooooooo++++++
+++++++++oooooooooooooooooooooooooooooooooooosssyyyhddmmNNNNNNNNNNNNNNNNmmmmmddhhyso+so:--:yo+///////////////////////////////////////////////////+oy:.......-:so++oooosssoooo+++o+/:--:/+ooooooo++++++++
+++++++++ooooooooooooooooooooooooosoooossssyyyyyhhhdddmmmNNNNNNNNNNNNNNmmmmmdddhhyso+++oo/:/ysooooooooooo+++/////////////////////////////////////+y+-......-/so+oooossssssssso+++oo+:----/+ooooo++++++++
+++++++++oooooooooooooooooooooooossoooosssyyyhhdddmmmmmmNNNNNNNNNNNNNNmmmmmdddhhyyso+///oysoo+:-.......--://+ooo++//////////////////////////////+so-......-+s++oooossssssssssooo+++oo/:-..-/++o++++++//+
+++++++++++++++ooooooooooooooo+oosssoooosssyyhhhddmmmmNNNNNNNNNNNNNNNmmmmmddhhysso+ooo+/-.```               ``.-:+ooo+/////////////////////////+so-......:oo++oooosssssssssssooooo++oo+/-..-:+++++++//++
-------::::////+++++++ooooooooooossssoooosssyyhhhddmmmNNNNNNNNNNNNNmmmmmdddhyso+oso:.``                          ``.:+oo+/////////////////////+ss:.....-+s+/+ooooosssyssssssoooooooo+++++/-..-:++++//+++
--------......---:::::///++++++oossssooooosssyyhhdddmmmmNNNNNNNNNmmmmmdddhysoooo/.`      ``....``                    ``:+o+/////////////////+oso-....-:so///oyyoooosssssssssooooooooo++++++/-..-/+++++++
/////////////:::-----....-----:/++oooooooooossyyhhdddmmmmNNNNNNNmmmmmddhysoooo:.     `-/syhddddhs/.                     `-+o+/////////////+oss/-..-:/oo+/+o+/so/+ooossssssooooooooooooo++++++/-..-/+++++
/+++++++++++++++++////////::::://///+o+++++ooossyyhhdddmmmmNNNmmmmmddhyyooso-`    `./ydmNNNNNNNNNmh+.                     `-+o+///////++osso/-..-/oysooo+/:-/s:://+ooooooooooooooooooooo++++++/:-..:/+++
++++++++++++++++++++++++o++++++ooooooooo++++ooooossyhhddddmmmmmmmdddhyooss:`     .+dmNNNNNNNNNNNNNNmy.            `..--.``  `-+o+//+ssso+:--.....--------.-/s+///::/+ooooooooooooooooooo++++++++/:..-:++
++++++++++++++++++ooooooooooooooosooooooooooooooossyyyhhddddmmmmddhhyosyy-      .ymNNNNNNNNNNNNNNNNNm/          .+ydddddy/.`  `:s+/+sso//::::::::/:......-/so++o++/::/+oooooooooooooooo+++++++++++/-.-:+
+++++++++++++++++oooooooooooooooosooooooooooooossssyyyhhhddddmdddhhyooy+s.     `/mNNNNNNmdmmNNNNNNNNm+`        :hmNNNNNNNmh+.` `-oo++++ooooooosyyo:.....-+so+oooooo+/:-/+ooooooooooo+++++++++++++++/:-.:
++++++++++++++++++ooooooooooooooossoooooooooooosssyyyhhhdddddddddhys+s+/s.     `/mNNNNmyo+osyyssshmNm+`       `smNNNNNNNNNNmy-` `.oo+////++osso+:-....-/os++ooooooooo+/-:/++oooooooo+++++++++++++++++/:-
/++++++++++++++++++oooooooooooooooooooooooooooosssyyyhhhhdddddddhhsoos//h:      `smNNNh++///+///+ymmh-        -dNNNNNNNNNNNNNd/`  -ssoossso+/:-....--/ooo+ooosooooooo+++:--:+ooooooo+++++++++++++++++//:
/+++++++++++++++++++oooooooooooooooooooooooooooosssyyyhhhhdddddhhys+so/yds.      .smNNmy+//////+sdmh/`        -dNNdhdmNNNNNNNNh-  `:y+//:--....--:/+oo+++ooosssooooooo+++/:--:+ooo++++++++++++++++++////
://+++++++++++++++++++ooooooooooooooooooooooooooossyyyyhhhhddddhhyo+y++ddd+`      `:ymNmdso+++oydds-`    `.`  `yNms+odNNNNNNNNm+`  `+s/:::://++ooooo++ooooosssssooooooo++++:-.-:++++++++++++++++++//////
::://////////++++++++++oooooooooooooooooooooooooosssyyyyhhhhhhhhyyo+y/odddh:`       `:+yhddhhhhy+-`    `-shs`  /dmy++oyhyyhmNNmy`   .s+//+++oooo+oooooosooossssoooooooooo+/:--..-/+++++++++++++++///////
...........--------:::////+++o+oooooooooooooooooooosssyyyyhhhhhyysooy/sddddh+`         `.-///:.`      `+dmmd-  `+ddo+////++ymNmy`   `++/++oooooooooooooooossssooooooooooo++/:-....:/++++++++++++////////
.................---------:::::/+++oooooooooooooooossssyyyyyyhhyyso+y/sddddddo.                      `/yyoyd:   `/hhs++++osdmNmo`    /o++oossssssssooooooosssoooooooooooo+++/-.....-:/++++++++//////////
///::::////////////////////++++++++++ooooooooooooooossssyyyyyyyyyso+s/sdddddddy-`                     `.``.o-    `-+yyhhdmmNNmy-     :o+oossssssssoooooooooooooooooooooooo+++/:-.....-:++++++///////////
/////::////++++++++++++++++oooo++++++++++oooooooooooosssssssyyyysso+s+odmmdddddh+.`                        ``      `.:+shhhhy+.     `+o++oossssoooooooooooooooooooooooooo+/++++/-......-/+++////////////
//////////+++++++++++++++oooooooo+++++ooooo+++oooooooooossssssyysso+os+dmmmddddddh+.`                                  ``````      `:yo++ooooo+++oooooo++++oooooooooooo+/:/++++//:.......:///://////////
////////////+++++++++++++oooooo++++ooo+/+oyys++++ooooooooossssyyyso++s+hmmddddmmmddy+-```       `-.`                             `./sy++++o+++oyys+//+oso+++++oooooooo+/:/++++++///-......-/////////////
---------:::::://///++++++++++++oo+/::/+ooosddhyso++oooooosssssysss++s+yddddddmmmmddmho/-.``   `+dho.   `.``                   `-+++s+++++osyhyo//::::::/ooo/:+++oooo+/:/+++++++++//:......-:///////////
---::::::::::::::::///////+//+oo/::/++/:+ddyosdmmdhsoo+oooosssssssoo+oooddmmddmmmmmmddddhy:.```.ymmh.` -yhy+`               `.:sy/:++//+shddy+/+shdho++/:::+o+///++++/://++++++++++//:--.....://////////
--::///////////+++++++++++/+o+:::+o+:-..-odmsooydhhddys++oooosssssoo++s/hmmdmmmmmmmmmmdddds-...:dmmo```smmmo`           `.-/ohddo:++/oydmds//+o+ymd+--:/++/:-:/+++/+:::/++/+++++++++///:-....-://///////
-.-:://////////////++++///+o/::++/-......-smh++sshdddddhs++ooossssso++s+oddmmmmmmmmmmmmdddy:..-+mmd/..:dmNh-````````.-:+shddddds/ossdmmds//o+:-ommo-....-:+o/:::/oo+::://///+++++++/////::-..-:///////:-
--..-://////////////////+o/::+o/-.........-smh/:osydmmmmmhs++ooossso++os/hmmmmmmmmmmmmmdddh:..-smms---ommm+....-+syhhdddddddddy/odmmmds//oo:.-/dmy-.......--/o+:--/oo/-::://++++++/:--/////:--///////:-.
::--.-://////////////:/++::/o/-............:ymh/-:osydmNmmmhs++oooooo++s/oddmmmmmmmmmmmmddh:..-ymd+-.-ymmh:...-sdddddddddddddy+ymmmdy+/oo:...:hmy:...........-/o+::-/o+--://+++++/:----//////://///:-.-:
:::--.-:////////////:/o/-:o+-...............:ymh/.-:osydmNNmmhs++ooo+++s+/hddmmmmmmmmmmddmh:..:hmy-.-:dmm+-..-oddddddddddddds+ymmmy+/oo:....:ymy:..............-:++:-:+o:://++++/:-.-://////////////:-:/
/:::--..:://///////::o/-:yh/-................:ymy:-.-/syhmNNNNmhs++++++oo:sddmmmmmmmmmmdddh:.-/dm+-.-+mmy--.-oddddddddddddhoodmmh+/oo:-....-smh/.................-+y/--+o-/++++/----:////////////////://
/::::--.--:////////::o:-+hdds:................:ymy:...-+yydmNNNmmho+++++s/+ddmmmmmmmmmmmddy-.-omh:..-smd/.../hdddddddddddh+sdmdo/+o:......-+dd/.................:sdds:-+o-:+++:-----:///////////:::::::/
::::::-----:////:::::o:-/s/ydd+-.............../hms-...-sdyydmNNNNmy+///s+/hmmmmmmmmmmmmddo-.-sms-..:hms-..-sddddddddddds+hmds+ss:........+dd+................-+hhoos:-oo--:/:----:://////////::::::::::
---------..---::::---o/-/s--/ydy/-.............-/ddo-...+mdyoymmNNNmds//oo:odmmmmmmmmmmddh:..-yd/..-/dd/.../ddddddddmdhooddy+ohdo......../hdo-..............-+hdo--o+-:s+/:-:----://////////:-::::::::::
::::::::::---:://::--+/-:s:..-+hdy:.............-+ddo-../hd+ossdmmmmmmy+/s//dmmmmmmmmmmddo-..:hy-..-+ds-..-sdddmddmmds+hdh++o++dy-......:hms-.............-/yds:..-s:-/s//:--:::://///////:-..-:::::::-.
:///////:::---:://::-++--o/....:oddo-............-omd+-.-yd+-/sohmmmNNmmoy+:ymmmmmmmmmmdh:.../h+-..-od/-..:hdddddddhosddo+o+-.:hd/.....-smy-............./yds:..../o:-+o::----://////////-...::::::::-.-
--:///////:::---://:-/o--o+......:ydh+-...........-smd+--omo-.:soymmmmmmmdo:sdmmmmmmmmdd+-.../y:...-yy-.-.+ddddddds+yds+oo:...-odo....-+dh:............:sdy/-.....o+-:s/----:://///////:-..-:/:::::---::
`.-:////////::---:/:::o:-/s-......-/ydy/...........-smd+-/dy-..-ossdmmmNNmy:+dmdmmmmdddo-....:/....-yo-.--sddddddoodh++o/-.....:dh:.../dd+...........-odh+-......:o:-+o---::/++/:////:-...::/::::--:::::
``..-:///////:::--:::-o+-:s:........-+hds:..........-smh/:dh:...-+yshyyyhdh//hddmmmmmms-..........-:s:...-sddddh+sds/ss:.......-sd+..:hdo-.........-+hdo-........++-:s:.-:/++++/:-//:-..-:/::::--::///::
```..-://///////:-----/o--o+..........:odho-.........-ymh/yd/..../ddsdmdddh//hddmmmmmh++++++++++//--:-...-ydddy+yds/shds:.......+dy--smy-........./yds:.........:o:-+o.-://++++//:--..-://::::-::/+/////
`````.-://///////::----o:-/s-...........:sdh+-........:ymhym+...-omdshmNNmm+/hmdddhhhs:/s++++++oooss+/-.-:hddy/ymh/o+:ohdo:...../hd+odd/........:sdy/-.........-o+-:s:-/+++++++//:..-::///:::://++++////
``````..-:////////::--.++--o/............-/ydy/-......./hmmmy/:-/hh+symNNNmhsysso+++s+..oo+++++++/++oos+::hdh/smd++o-..:ohho:--+yyyyyds-......-+hh+-.......-:+shy:-oo:/+++++++//:-.-:///:::///++++++++++
````````.--::///////:-.:o:-+o-.............-+ydy/-....../hdhyyy+yd+.ssmmmmmy++ooossyyo++shssoo+++++++++osohd+smmy/s:.....-ohdsshysssssys:...-/ydo:.....-:+syhyoy+-/o//++++++///---::-::::////++++++++ooo
`````````..--::::://::--o/-:yhyso+/--........-+hds:....-+yyssshddo``+sdmmmmhyhhdddddy+/oddmddddhhyso+++++shy+dmd+++-......-:oddysssssssyy::/sdy/-..-:+syyso/--+o::s///+++++//:--:://:-::///++++++++oooo+
`````````...-::///////:-/o:-+hssyhhhyso/:--....:sdho:--+hssssshmy. `:hhmmmdhyyyyyddmdh+/ymdmmmdddddddhso++ohdmmy/s:........../hyssssssssyyyyhho::/oyhyo/--...:o:-oo://++++//:-::/::::-://+++++ooooooo+/:
...```````...-:://////:::o/-:s/---:/+osyyyyyso++yhyyyssyyssssshh-```-hdyo++//+oyyysyhhh/+dmmmmmmmmddddddhyohNmmo+o-........--:syssssssssssssssyhhhs+:-......-+/-/s////////::::////:::///+++++ooooo++/-..
-----....`...---://////::/o:-/s-.......--://ooydhssssssssssssydho+/::yhmhs+////+yhddyso/:ohmmdddmmmddddddmdmmdyosy:-::/++oosyyyhsssssssssssssssho-........../+::o/////://:://///::-://+++ooooooo+/:-..``
----::-----------://////:-o+--o+-.............-oyssssssssssssymy++osyhymmdsos+//oysmmmyooooyhdddmmmmmddhyysso//+ydhhyyyso++/::+hysssssssssssssyy:..........:o::o+/////::///////:--://+++ooo++++:-..`````
-----::::::::-----://///:-:o:-:o/..............:oyysssssssssshmh:```.oymmy/+yso+s+/dmmds/sooosyhhhhhhhhso+///+osho/::---...-/yddhyssssssssyyhho:..........-o/:++//////:://///::--:///++ooo++/:-.````````
------:::::::::---:::///::-++--/o:..........--::/ohdhhyyyyysshshy-```oymms//y//sy:-yddhy/oo-://odmmmdddyo/:/oyoos-.......-:sdds//syyyyyyhdhyhhhso/:--....-++-+o://////:::///::-::://++oo++/-.`````````..
--------:::::::::::::://::-:o/--/o:--::/++syyyhhyyso+/+dyodho/.:hy-``+ymms//h+.--.`:oo:--:o/-/sshmddyo/osyyhhhsy+.......:ohds/-..-/hdo::smh:-:/osyhhyso+/o+-/o/:///////:::::::::////++//:-.`````````..--
:::---------:::://::::::/::-/o:--+yyhhyysoo+/:--.````.sh:.hh.```:hs.`+sdmo//yh:````...````-+o+s+/oyy:--+o+ymmh/s/.....-+yds/-....-ody-..:hd/.....-:/+oyhdo::o+/////////::::::/://////:-..````````..-----
::::::-------::::///::::/::::/++:-:/s+-.```         `+d+``sh-`  `:hs./sdmo//ody-```````````.-/so:-:/::oy/+dmmy/s:...-/ydy/-......+dd/...-sms-.........:o+::+/:////////:::-:::::::::--...``````...-------
:::::::::----::::://///::::::::/++:--/+/.          `:hs.``od/    `/ho+sdms/:/hmy:.`````````...-:----:odh/+dmms/s-.-/ydh+-.......:hms-....+dh/.......-/o/-:++:////////:::---:::::----.....``..------::---
-:::::::::::-:::::///////::::::::++/---/+/.       `-yh-   /do`    `+hhymms/:/odmd+-```.--.``..```../sdmdo/hmms+s-:sdho-........-smh:.....:hdo.....-/so:-/o/://////:::-:::--:::-----.......-------:::::::
---::::::::::::::::://////::://////++/:-:/+:.`    .sd+`   :ds`     `+dymmh/::/sdmmh+-.`.--.-:...-/shdmmmo/ymmo+yshds:.........-+dd+......-ymy:..-/o+/:/oo:://////::-::::::--------.....----::::::::-::::
----::::::::::::::::://////////////::/+/:--:+/.` `+ds.    -dh.      .symmdo/::/sdmmdhs+:-..-/+syhddddmmd+/smd++dds/...........:hms-.......omd+-/o+::/+o/:://///::-:::::::------------------::::----:::::
------::::::::::///::////////////////::/++::-:/+:/hh:     .hd:      .oymmmh+:::/sdmdddddhyhhdydddddddhhh/:+dms/oo:-..........-sdh:........:dmyo+::+o+/:://///:::--:--:------:::::::---------------::::::
::----::::::::::://///:://////////////::::++/:-:/sho`     .yd/`  ``-oshmdhhy+---:ohdddddyhdddyydddhhddds/:/hmds:://:-........+dd+........-/ys+:/+o/:::////::::------------::::::::-----------:::::::::-.
::::::::::::::::::::////////////////////::::/+/:--/+/:.`  `odo```:+sydmhoshdh+--++oydddssddmmdooyhddddh+:::smmmho/:/+:-.....:hmy-.....-:+o+//+o/:::://////:--------..--:::::::::::::----::--::::::::-...
:::::::::::::::::::::::://///////:::::///::::-:/+/:-://:-``+dy-:osydmdssdddddho/sddhhhyoshdmmmdddddddds:::.+mmmmmds/:/+/:-.-odd/...-:/++///o+/-:::///////:-------...--:://///////::::::::::::::::--.....
:::////:::::::::::::::::::://////:::::::/::::::--:///:-:/+/+hyosydmmdshdddmmdddhsyddmhoyddddddddddddds//++-ommmmmddhyo//++++hds--:+oo///o+:--:::://////::-----.....--://///////////::::::::::::-------::
//:///////::::::::::::----::////:::::::::::::::::---:/+/:::/+shdddmmhdddddddmddddddmdyhddddddddddddds/+shs+hmmmmdddddddyo///syo+o+//+++/---:::////////::---.......--://////////////::::::::::-----:::///
////////////:::::::::::-----::://:::--:::::::::::::::--:/++shdmmdmmmmdddddhhmddddddmmddddddddhhmdmdysydmdshmmmmmddddddddmdy+/////+++/:--:::::://////::--.........-:://////++++////:::::::::-----::////::
/////////////:::::::::::----::::::::-----::::::::::::::---/hddddddmmmdddhhyddddddddmmdddddddysddddddddmmddmmmmmddddddddddddy++++/:---::::::////////:--.........--::://///+++////::-::::::---------------
////////////:::::::::::------::-::::---------:--::::---:/+ohddhsshdmmmmhyoydddddddddddddddho+ydddddddddssdddmmmmhhhdddddddddyo+:------::::://////::-.........---::::////++////:---:::---------..........
////////////:::::::::----------:---------------------:+osydddhysyhddddhs+/+osyyhdhhhddhyso+/+shddddmddo.-/osyhdmdhsshhddddddddhhyo+/---::::::/:::-.........--::-:::////////::---------------------......
:::::///////::::::::---------------------.......-:/+osyddddddhddddhhdho++oo+/::------/+oo+/+oosyhddmdh:-------//:-..:/oyhdddddddddhyso/---::::---........--:----::://////:----------::::::::::-------:::
:///////:::::::::::-----------.---------....-/+osyyyhdddddddddddddddddyys/.````````````.oso+-..--:osso---------------..-oyhdddddddddhyss+-----..........------:::::::/::---.---::::::////////:::::://///
-:::::::/::::::::--------------..........-/+syyhddddddddhhyyyssso+oyhhhhy-`````````````.oy+.````./+:+-.---------------.../oshddddddddddhyy+-............----------::::--..--::::::////+//////////++++///
...--::::::::-----------------........-/+oshdddddddddsooooo+/:-.-------:o.`````````````.ss.`.:///--+-..-------...-----...../oshdddddddddddhyo-`............--..------...--:::::://////////////+++++/////
:--..---------------------........``-+syhhhhdddddhdhso/:-....----::---.:+.```````...-:/+s+``--.``-+:...--.................``-ysyyhddddddddddhyo-`.....................------::::///////////+++++++//////
///:---...--::::------------....``:oyhddhddddhhddysy+```...-------::--.:/-//////////:-.o:.``````-+-........................``/soosyhhddddhddddhyo.`................----..--::///////////////////////////
////:/::--...--::::-------....``-ohhdddddhhddhysssy+.`.....-----------./:.o-`-:///////:+:``````:o-...........````````......```:o//+y+oyhhdddddddhs:``...................--:::::::::::://////////////////
////:::::::---..---------...`.:shdddddddhysssoosy+.``........--------../:.o++:.```````--.`````-+-..........````````````````````:o//o/`.:oyhddhhhdhh+.``.........`.--....--------:::::::::::::::://///+++
///:::::::------//-..----.../shdddddhhysooyysoo+-```...........------..+-`...``````````...```-+-..--......``````````````````````-++/o- ``./yhdhhhhddy:.``.-::---/::+....------------:-:::::::://///////+
////::::::---..-o/+-``..-:+yhddddhysoo/::+so+:.````..............----..+-``-::...-----:/++```/:..---.....`````````````````````````/ooo:````-oyddhhhhddy+/:----::-:+:.....------------:::://///++///+////
++////::-----...+/://///oyhdhhhyso/-`.:oo+:.````````````.........----..+:``++-:::::::::.o-``.+...--.....```````````````````````````.:+s/.````:shdhhhhhy:````.//::-.`.....---------::::::////////++++++//
////::::::::--...-:/-``:hhhhdhso:````/+:.`````````````````........--.../:`.+o////::---//o:``./...........`````````````````````````````.-....``-shdhhyo.`````-/````....------------:::::::////////+++++++
/////:::--------..`./.`-yhhhhyo.`````..`````````````````````...........+:`.++:.````````..````./:.........``````````  `` `````````````````....``.sh+:.```````./-``...---......------:::::///////+++++++++
+++++//:::---.....``-s/-:+syss-```...```````````````````````.........-+:```...........---:/+/`.:/........``````````        ``````````````....```.s:``````````./:``...........-----:::::::::////+++++++++
++++/////:::---...``.o:oo...-/````.`````````````````````````........//.```.+//////:::::::-`:/```-+-.......`````````           `````````````...```-/```````````./+-```.......---::::::::::::///////++++++
++++++////:::---...`.+/o//``./``````````````````````````````....``-/:``````:/.///:---..--::/+````-+-`......```````````           ````````````````-:.-::.``````..-/+-``...----::::----::::://////+++++++o
+++++///////:::---..`.-.`+-./:`````````````````````````````...``.//.```````.//-.``````````.-.`````./-``.....``````````            ``````````````::.::`/-.//:../:+:-+-`...---..-------:::///+++++++oooooo
+++++//////:::::---...``///s:````````````````  ````````````````./:`````````````````````````````````./:.`.....`````````              ```````````-/-/-`././-`:/.+.`/:-+.``.........---::///+++++oooooooooo
+++///////::::-----...`-o+os. ```````````      ```````````.````/:```````````````.-:/::.``````````````-/:.`....`````````             ```````````//:.  :/-/` `/-/- .///+.```....---::////+++++++oooooooooo
////:::::::::-----....`.:o++` ````````           `````````````::```````````````.+++oooo+-``.-:--.`````.:/-``...```````````            ` ``````````  `+-/.   -/::  `-/+-`...----:::::////+++++++ooooooooo
/:::::-------.........````::`````````             ```````````-/.````````````````:oshhyyys+++++++o.``````.:/.```...`````````               ````````  :/::`   `+:: ````.`...-----:::////++++++++oooooooooo
---------.........`````````````````              ````````````/-``````````````````-shhhhhyssyyyyss-````````-/:```..`````````                 `````` `//:` ````:+:````.....-----::://///+++++++++ooooooooo
------.......``````````````                      ```````````./.```````````````````-ohhhhhhhhhhhho.``````````:/-```.``````````                  ```````````````.``````........---::://////+++++++++++++++
-----.....`````````````````                      ```````````-/```.-:::/+///:-`````./shhhhhhhhhho.````````````./:.``..``````````                      ````````````````````````....---::://///++++++++oooo
----.....```````````                              ``````````:/`./+:.``.:////++/-..+++syhhhhyhy+.```````````````/+-``..``````````                     ``````````````````````````...--:::////+++++++++++++
----.....```````````                             ```````````-+-++/:--::/+++++/+++oo+s++yhhhyo-````````````````-+++:``````````````                  ````````````````````````````....---:::::///////++++++
---......`````````                                ``````````.++o/+o+:...-///++oooo+oo/oyyhs/.````````````````-o///s/.```.````````                    ```````````````````````````....----::://////+++++++
/::----......````````                            ````````````+s/+o/::--::++++////+oyoohhys+-````````````````.++:/oo+/.``..``````````                      `````````````````````.....---:::://////+++++++
ssssoooooo+oo++ooo+/`````````                    ````````````-o+s+:/oyyyhhhhyyyso+//oyhyhyo+.```````````````:o/:+s/:/+.``.``````````                              `````````````.....----::::::///////+++
hhyyyyyyyyyyyyyyyyys/////////////////:://////:`   ````````````:ss/:+yhyhhhhhhhhhhys++hhyyhs+/.``````````````/+:/o+:::++.`````````````                                   ````````......----:::::///////++
hhhhyhhhhhhhhhhhhhhyyyyyyyyyyyyyyyyyyyyyyyyyys`   ``````````.`./s//ohhyhhhhhhhhhhhhhyhhyyyho/+//++//:--..``.++:/s/::+s++-```.`````````                                 `````````......----::::://////+++
hhhhhhyyhhhhhhhhhhhyyhhyhhyyhhhhhhyyyyyyhhhyyo`   ``````````.``./o/:yhyyyyyyyyyyyyhyhhhhyyyy++o////---:/+/::o//+s/:/shy++.``..````````                                 `````````.....----:::::///////+++
yyhhhhhyhhhyhhhyyyyhhyyyyyyyyyyhyyyyyyyyhhhyy+`    `````````...`.-+:+yyyyyyyyyyyyyyyyyyyyyyhy/o+////-.``-:/++//+s/:+yyys//.```.````````                                   ```````....----::::////////+++
hhhhhhhhhhhhhhhyyyyyyyyyyyyyyyyyyyyyyyhhhhhyyo`      ```````.......:/oyhyyyyyyyyyyyyyyyyyyyyhs/so+++++/:://////+s//syyyyo/+`````````````                                   `````````....--::::///////+++
hhhhhhhhhhhhhhhyyyyyyyyyyyyyyyyyyyyyyyhhhhhyyo`     `````````.....``./yyhhyyyyyyyyyyyyyyyyyyyy++o/:///:...:+oo++s//shyyyy///`````````````                           ``` ```````````````....---::////++++
hhhhhhhhhhhhhhhyyyyyyyyyyyyyyhhhhyyhhhhhhyyyyo`      ````````.....`-+yhhhhhyyyyyyyyyyyyyyyyyyhy:+y+:+sso+/--//+oo//yyyyyys:+-````````````                  ````````````````````````````.....----::///+++
yyyyyyyyyyyhhhhyyyyyyyyyyyyyyhhhyhhhyhhyyyysso`      ````````...``-syhhhhhhyyyyyyyyyyyyyyyyyyyys/+o+//syyyyyso///:/yyyyyyy+:+.``..````````                ```````............................----:://+++
+++++///::ohhhhyyyyyyyyyyyyyyhhhyhhhhhy/-.--...`      ```````````.oyhhhyyyyyhyysyyyyyyyyyyyyyyyyyo+o//:/syyyyyyso//yyyyyyys::/``...````````                 `````....------:::::::::::----::::::////++++
yyyyyyyyyyyhhhhyyyyyyyyyyyyyyyhhyyyyyyyyyyyyyys-       ``````````-yyyhhyyyyyyyyhyssyyyyyyyyyyyyyyyso/-//:+yyyyyyhyshyyyyyyyo-/:```.``````````                  ````...----:::::://///////////////+++++++
yyyyyyyhhhhhhhhyyyyyyyyyyyyyyyyhhyyyyhhhhhhhhyy:       ``````````-syyhhyssoosyyyyyyyyyyyyyyyyyyyyyys/..:+::oyyyyyyyhyyyyyyyy/-+.``...`````````                  ```````..--:::////////////+++/++++++++++
yyyyyyyhhhhhhyyyyyyyyyyyyyyyyyyyyyyyyhyhhhhhyyy-    `.```````````.o/oyyyyyyyyooyyyyyhyyyyyyyyyyyyhs+....-//:/syyyyyyyyyyyyyys::/.``...```````````  `    `````````````````...--::///+++++++++++++++++++++
hhhhhyyyyhhyhhhhhhhhhhhhyyyyyyyyyyyyyyhyhhhhhyy-`   `o+```````````++o/syyyyyyyy+oyyyyyyooyyyyyssy+-..---..-//:+yyyyyyyyyyyyyys-/:```...`````````` ``  ````````````````````.....--::///++++++++++++++++++
hhhhhhhhhyhyhhhhhyyhhhhhyyyhhhhhhhhhhhhhhhhhhyy-    .s/```````````.+:`.syyyyyyyyo++ooo+/:://///:....-----...:+/:syyyyyyyyyyyyyo-+-``.....``````````   ```````............-......---::://////////++++++oo
yyyyyhhhyyyyhyhyyyyyyyyyyyyyyyyyyyyyyyyyyyyhyyy-    :s-````````````````-yyyyyyyys-`.-::::--............-......:+:+yyyyyyyyyyyyy+-+-``.....```````````   ``````.....------:::::::-----::::::::///++++++++
ooooooooo+++++oooo++++++++/////////++////++++//.    :s-`````````````````+yyyyo///+/.``........................`.///syyyyyyyyyyyy+:+-``......`````````````````````..----::::::::--------:://////++++++++/
sssssyyysssssssssssssssssssooooossssssssssss+`      .so::/+/.```````````.osyo:::::/+-``........................``./+oyyyyyyyyyyyy+:/:``.......`````````````````````..---::::::/:::::///+++++++++++++++++
hhhyyyhyyhhhyyyyhyhyyhhhyyyyyyyyyyyyyyyyyyyys`       .:::-.` ````````````:o+/:-:::::+:``......```````````........``:+/syyyyyyyyyyyo:/:``........``````````````````````..--::///////+++++++++++++++++++++
hhhhhhhhhhhhhyhhhhhhhhhhhhhhhhhhhhhhyhhhhhyys`         `--`  `````````````/+:-`.-:::/+.``````````````````````....```-+/oyyyyyyyyyyys//+:.``........````````````````````...--::////+++++++++++++++ooo++++
hhhhhhhhhhhhhhhhhhhhhhhhhyyyhhhhhyyyyyyyhhyyo`          /s/-`  ````````````/+/-..:::/o. `````````````````````````.```./++syyyyyyyyyyys+//:.``..........`````````````........--:////+++++++++++++++//++++
yyyyhhhhyyyyyyhhhhhhhhhhhhhhhhhyyyyyyyyhhhyyo`          :s:.`    ````````` `.:///:://-` ```````````````````````````````:/:/osyyyyyssssys+///:.``...........`````...........------:://++++++++++++++//+/+
ssosssooooooo++++syhhhyyhhhhhhhhhyyyyyyyhhhys.       `-:os:`       `````````  `.....``  ```````        `````````````````./:--:/osyysssssyso/::/:-.`.....................--------::::://+++++++++++++++//
yyyyyyyyyyyyyyyyyyhhhhhhhhhhhhhhhyyyyyhhhhyys.       .osso++`         ````````       ``````                ```````````````-/:-.-:+syssssssssso/:///-..................--------:::::::://///+++++++++++++
hhhhhhhyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyhhhhhyys`        `..```             ``````                             ````````````````-::/osyyssssssssssss+/://:-..------------------::::::::/:::::://///+++++++++
hhhhhhhyyhhyhhhyyyyyyyyyyyyyyyyyyyyyyyyhhyyyo``      `:--.`                                                    ```````````````-:/+oyyssssssssssssso+:::/:---::------------:::::::://///////::://////////
yyyyyyyyyyyyyyyyyyhhhhhhhhhhhhhhhhhhhhhhhhyyo``      `+o+/`                                                      ```````````````.:/+osysssssssssssssso/:/+:--:::::::::::---::::://///////////::://::://+
+++oooooooooooo++shhhhhhhhhhhhhhhhhhhhhhhhyys``     -/++++-`                                                      ````````````````.-/+ossyssssssssssssso+::/:-::////::::::::::::////////////////////::::
yyyyyyyyyyyyyyyyyhhhhhhhhhhhhhhhhhhhhhhhhhyyo```    .--``+o``                                                      `````````````..```.:/oossssssssssssssss/:/+--://///////::::::::::///////////////////:
hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhys.```     ``-s+```                                                    ``````````````......`.-/++osssssssssssssso//+:-::////+//////:::///////////////////////
hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhys.`````` `.:o/.`````                                                  ``````````````...........:/++ssssssssssssss+/+/-://///++///////////////////:://///////
hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhys.```````./:.``````````                                              ````````````````............://+osssssssssssso://::///////++///////::::://////:::://///
hhhhhhhhhhhhhhhhhhhhhyssssssssyyssssssssssso+.`````````````````````                                        ```````````````````````.......--....-///+osssssssssso:/+::///////////://////:::::::::::::::::
hhhhhhhhhhhhhhhhhhhhhyo+/++ooosoo+o+++++++++++//.``````````````````        ```                        `  `````````````````````````.......------..-:///ossssssssso//+:://///////:::::::/::::::::::-------
hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhys.````` ````.....```       ````````                ``````````````````````````````........------------:///+ossssssso://-://////:::-----:::::::::----::::::
hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhs.`````````.......``      ``````````        ``   ```````````````````````..```````........--------:::----://+osssssso://--://///:---------:::::::::---::::
hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhs.....````.......````````````````````    `````````````````````...............````..---------------:::::::--:/+ossssso:+/--://///::----..----::::::::----:
hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhs-----.```..----.``````````....`````````````````````...............................-:---------:---:::////::-.-/+osssso///--::://::::---.....--::::::::---
hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhs:-----.```.-:--..````````.....```````````````````..............--..-----------....-:::::---::::::::://////::-.-/+ossss+++:----::::::::--.......--:::::::
hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhs:::::--.``.---......`````..-...`.....```````````.....-------..------------:::-------://::::::::::::::://///::--.-:+osssso++///::---:::::--........--::::
hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhy/:::::::-.`-:-.......```..--.......-.......````.....-----::-----::---:----:/::-:::--:////:::::::::::::://///:::--../+ossssso+/////--:::::-----......----
hhhhhhhhhhhhhhhhhhhhhysoooossssssssssssoooosssso/://:///::..-------.......----.--------.........-----::::::::::::::::::::-:/::--:/:--:////:::::::::::::://///:::--..:++osssssso+::+--::::::-----........
hhhhhhhhhhhhhhhhhhhhhy::::-----:::::::-...://:::://///////:::------.......------:::-::-----....-----::::::////:://///:::::://--:////:://///:::::/:////::::///:::---..:+/ossssssss///--:::::::------.....
hhyyyyhhhhhhhhhhhhhhhy/:::---:://::-:-...:////:://///+++++//::::::-.......--::::::::::::::-----:::-:://///////////////////:::-://////://///::::////////::::://:::---..:+/osssososs/+--::::::::-------...
//::-::::::://////////:::---::///:----.-://////////+++++++///::::-...``..-::::::://:///:::::::::::::///////////////////////:-:/+++////////:::///////////::::::/:::::--.:+/ssooooss+//--:::::::::--------
-....``..-----:------::---::////:::----//////////+++++++++++////:--..``..-://::////////:://:///////////+////+++++++//////+/:://++++//+///:::://///////////::::::::::::--:/+ssooooss++--::::::::::-------
..```..----------:-.-:---://///:::-..://////////:/++++++++++++//:--.``..-:///////////////////////////+++++/+++++++++++++++/://+++++//++//::://////////////:::::::::://:-.:+osoooooss/.--:::::::::::-----
````.----------::::-.--://///::::...:-://////////:++++oo++++++//:--.`...:///////+++++//////++++++++/+++++++++++++++++++++//++//+++++//+/:://///////////////::::::::///::--:+ossssoooo+---:::::::--------
``..-------..-:::::-.-::://::::-...://://////:/+++/+++oo++/++++/:--....-///////+++++++////+++++++++++++o++++++++++++++++++++++/++++++///:///////////////////::---:://///:--/+oo+////+oo/--:::::--------.
..-------..-::::::---.-::/::::-..-/////:////::+++++/+oo++//++++/:--..--:+++++++++++++++/++++++++++++++oooo+++oo+++++++++++o++++/++++++/://////////////////:/:------::///::--o+::::::::/o:.-----.........
-------...-:::::-.-:-..-:::::--.://++++/:/:::+++oo++++o++/+++++/:-----:/++++++++++++++++++++++++++++++ooooo++oooooo+++++++o+++++/++++////////////////////::::--------::/::--+/::::.`.::+:`............``
-----...-:::::--.-:::-..-:::--.://+++++//://++++ooooo++oo++++++/::---:+++++++++oooo+++++++++++++++++++oooooo+oooooooooo++oooooo+/++++/////++///++///////::::---:::----::::--+/::::.`-::+:``.............
EVERYTHING IS IN A HEADER!? NANI SORE!!?
*/

#ifndef DATASTRUCT_HPP
#define DATASTRUCT_HPP
#include <GL/gl.h>
#include <GL/glu.h>
#include <sstream>
#include <algorithm>
#include <iostream>
#include <fstream>
#include <string>
#include <vector>

//CONTAINERS
struct vec{
	double x;
	double y;
	double z;
};

struct pt{
	double x;
	double y;
	double z;
	int bind;
};

struct uv{
	float u;
	float v;
};

struct tri{
	int a, b, c;
	int na, nb, nc;
	int ta, tb, tc;
};

//first line is of form x,y,z of base node
//next lines are of form  id:parent_id:x,y,z
//	where x,y,z are angular anchors that can be define to make the vector from parent arbitrary length.
//	however the len is the actual rendered length of the bone which is calculated using the initial x,y,z
//	the x,y,z can later be changed to only define and interpolate the angle
struct bone{
	int id;
	int par;	//parent id
	vec len;
	pt start;
	pt end;

	//updated orientation
	pt nend;
	float rx,ry,rz;
	double cx,sx,cy,sy,cz,sz;	//stores cosine and sines for rotation

	std::vector<int> child;
	std::vector<int> binds;
	std::vector<vec> vcs;
};

struct pose{
	std::vector<float> rx;
	std::vector<float> ry;
	std::vector<float> rz;
	double x,y,z;	//displacement of entire model, only on node 0
	int toFrames;	//defines number of frames to jump to this pose
};

struct model{
	GLuint tex;
	std::vector<vec> norms;
	std::vector<vec> unorms;
	std::vector<uv> uvs;
	std::vector<pt> verts;
	std::vector<vec> uverts;
	std::vector<tri> faces;
	std::vector<bone> bones;
	std::vector<pose> poses;
};

double dist(pt a, pt b){
	double dx = a.x - b.x;
	double dy = a.y - b.y;
	double dz = a.z - b.z;
	return sqrt(dx*dx + dy*dy + dz*dz);
}

double distsq(pt a, pt b){
	double dx = a.x - b.x;
	double dy = a.y - b.y;
	double dz = a.z - b.z;
	return dx*dx + dy*dy + dz*dz;
}

double dot(pt a, pt b){
	return a.x*b.x + a.y*b.y + a.z*b.z;
}

double distP2L(pt v, pt w, pt p){
	double l2 = distsq(v,w);
	if(l2 == 0){
		return dist(p,v);
	}

	pt dp; dp.x = p.x-v.x; dp.y = p.y-v.y; dp.z= p.z-v.z;
	pt dw; dw.x = w.x-v.x; dw.y = w.y-v.y; dw.z= w.z-v.z;
	double t = dot(dp,dw)/l2;
	if(t < 0){
		return dist(p,v);
	}else if(t > 1){
		return dist(p,w);
	}

	pt pr;
	pr.x = v.x + t*(w.x - v.x);
	pr.y = v.y + t*(w.y - v.y);
	pr.z = v.z + t*(w.z - v.z);
	return dist(p,pr);
}

double rad(double deg){
	return deg*0.01745329251;
}

void bind(model &m){
	for(int i=0; i<m.verts.size(); i++){
		m.verts[i].bind = 0;
		double minDist = distP2L(m.bones[0].start, m.bones[0].end, m.verts[i]);
		for(int j=1; j<m.bones.size(); j++){
			double nm = distP2L(m.bones[j].start, m.bones[j].end, m.verts[i]);
			if(nm <= minDist){
				m.verts[i].bind = j;
				minDist = nm;
			}
		}
		m.bones[m.verts[i].bind].binds.push_back(i);

		vec vt;
		vt.x = m.verts[i].x - m.bones[m.verts[i].bind].start.x;
		vt.y = m.verts[i].y - m.bones[m.verts[i].bind].start.y;
		vt.z = m.verts[i].z - m.bones[m.verts[i].bind].start.z;
		m.bones[m.verts[i].bind].vcs.push_back(vt);
	}
}

void bindSmooth(model &m){

}

int ang = 0;
int ango = 0;
int cframe = 1;
int mframe = 5;

enum movement {idle,run,jump};
movement mstate = idle;

void arotate(model &m){
	if(mstate == jump){
		ango = 8;
		ang = 8;
	}else{
		cframe++;
		if(cframe > mframe){
			switch(mstate){
			case idle:
				cframe = 0;
				ango = ang;
				ang = (ang+1)%3;
				break;
			case run:
				if(ang < 3){
					ang = 3;
				}
				cframe = 0;
				ango = ang;
				ang = 3 + (((ang-3)+1)%5);
				break;
			}
		}
	}
}

void updateBones(model &m, double charx, double chary, double charz, double crot){
	m.bones[0].nend.x = 0;
	m.bones[0].nend.y = 14;
	m.bones[0].nend.z = 2;

	double crs = sin(crot);
	double crc = cos(crot);

	double ratio = cframe;
	mframe = m.poses[ang].toFrames;
	ratio /= (double)mframe;
	m.bones[0].rx = (m.poses[ang].rx[0] - m.poses[ango].rx[0])*ratio + m.poses[ango].rx[0];
	m.bones[0].ry = (m.poses[ang].ry[0] - m.poses[ango].ry[0])*ratio + m.poses[ango].ry[0];
	m.bones[0].rz = (m.poses[ang].rz[0] - m.poses[ango].rz[0])*ratio + m.poses[ango].rz[0];

	double dx = (m.poses[ang].x - m.poses[ango].x)*ratio + m.poses[ango].x;
	double dy = (m.poses[ang].y - m.poses[ango].y)*ratio + m.poses[ango].y;
	double dz = (m.poses[ang].z - m.poses[ango].z)*ratio + m.poses[ango].z;
	for(int i=1; i<m.bones.size(); i++){
		//set angles
		m.bones[i].rx = m.bones[m.bones[i].par].rx + (m.poses[ang].rx[i] - m.poses[ango].rx[i])*ratio + m.poses[ango].rx[i];
		m.bones[i].ry = m.bones[m.bones[i].par].ry + (m.poses[ang].ry[i] - m.poses[ango].ry[i])*ratio + m.poses[ango].ry[i];
		m.bones[i].rz = m.bones[m.bones[i].par].rz + (m.poses[ang].rz[i] - m.poses[ango].rz[i])*ratio + m.poses[ango].rz[i];

		//set rotation of end about parent based on angles
		m.bones[i].cx = cos(rad(m.bones[i].rx)), m.bones[i].sx = sin(rad(m.bones[i].rx));
		m.bones[i].cy = cos(rad(m.bones[i].ry)), m.bones[i].sy = sin(rad(m.bones[i].ry));
		m.bones[i].cz = cos(rad(m.bones[i].rz)), m.bones[i].sz = sin(rad(m.bones[i].rz));

		vec vn = m.bones[i].len;

		double nx, ny, nz;

		//use x rot
		ny = vn.y * m.bones[i].cx - vn.z * m.bones[i].sx;
		nz = vn.y * m.bones[i].sx + vn.z * m.bones[i].cx;
		vn.y = ny;
		vn.z = nz;

		//use y rot
		nx = vn.x * m.bones[i].cy + vn.z * m.bones[i].sy;
		nz = vn.z * m.bones[i].cy - vn.x * m.bones[i].sy;
		vn.x = nx;
		vn.z = nz;

		//use z rot
		nx = vn.x * m.bones[i].cz - vn.y * m.bones[i].sz;
		ny = vn.x * m.bones[i].sz + vn.y * m.bones[i].cz;
		vn.y = ny;
		vn.x = nx;

		//set new end based on rotation
		m.bones[i].nend.x = vn.x + m.bones[m.bones[i].par].nend.x;
		m.bones[i].nend.y = vn.y + m.bones[m.bones[i].par].nend.y;
		m.bones[i].nend.z = vn.z + m.bones[m.bones[i].par].nend.z;

		for(int j=0; j<m.bones[i].binds.size(); j++){
			vec vv = m.bones[i].vcs[j];

			//use x rot
			ny = vv.y * m.bones[i].cx - vv.z * m.bones[i].sx;
			nz = vv.y * m.bones[i].sx + vv.z * m.bones[i].cx;
			vv.y = ny;
			vv.z = nz;

			//use y rot
			nx = vv.x * m.bones[i].cy + vv.z * m.bones[i].sy;
			nz = vv.z * m.bones[i].cy - vv.x * m.bones[i].sy;
			vv.x = nx;
			vv.z = nz;

			//use z rot
			nx = vv.x * m.bones[i].cz - vv.y * m.bones[i].sz;
			ny = vv.x * m.bones[i].sz + vv.y * m.bones[i].cz;
			vv.y = ny;
			vv.x = nx;

			m.uverts[m.bones[i].binds[j]].x = vv.x + m.bones[m.bones[i].par].nend.x;
			m.uverts[m.bones[i].binds[j]].y = vv.y + m.bones[m.bones[i].par].nend.y;
			m.uverts[m.bones[i].binds[j]].z = vv.z + m.bones[m.bones[i].par].nend.z;

			//do rotation about y axis;
			vv.x = m.uverts[m.bones[i].binds[j]].x;
			vv.z = m.uverts[m.bones[i].binds[j]].z;
			nx = vv.x * crc + vv.z * crs;
			nz = vv.z * crc - vv.x * crs;
			vv.x = nx;
			vv.z = nz;

			m.uverts[m.bones[i].binds[j]].x = vv.x;
			m.uverts[m.bones[i].binds[j]].z = vv.z;

			//do translation based on node 0
			m.uverts[m.bones[i].binds[j]].x += dx + charx;
			m.uverts[m.bones[i].binds[j]].y += dy + chary;
			m.uverts[m.bones[i].binds[j]].z += dz + charz;
		}
	}

	for(int i=0; i<m.norms.size(); i++){
		double nox = m.norms[i].x;
		double noz = m.norms[i].z;
		double nx = nox * crc + noz * crs;
		double nz = noz * crc - nox * crs;

		m.unorms[i].x = nx;
		m.unorms[i].z = nz;
	}
}

std::vector<bone> parseSkl(const char* fname, double scl){
	using namespace std;

	std::vector<bone> ret;
	int id = 0;

	string s;
	ifstream f;
	f.open(fname);

	getline(f,s);
	replace(s.begin(), s.end(), ',', ' ');
	stringstream ss(s);
	bone b;
	b.id = id++; ss >> b.end.x >> b.end.y >> b.end.z;
	b.start.x = b.end.x;
	b.start.y = b.end.y;
	b.start.z = b.end.z;
	ret.push_back(b);

	while(!f.eof()){
		getline(f,s);
		if(s.find("r") == 0){
			break;
		}else{
			replace(s.begin(), s.end(), ':', ' ');
			replace(s.begin(), s.end(), ',', ' ');
			stringstream ss2(s);
			int idx;
			ss2 >> idx;
			ret[idx].child.push_back(id);
			bone nb;
			nb.par = idx;
			nb.start.x = ret[idx].end.x;
			nb.start.y = ret[idx].end.y;
			nb.start.z = ret[idx].end.z;
			nb.id = id++;
			ss2 >> nb.end.x >> nb.end.y >> nb.end.z;
			pt p = ret[idx].end;
			float dx = nb.end.x - p.x;
			float dy = nb.end.y - p.y;
			float dz = nb.end.z - p.z;
			vec vb;
			vb.x = dx;
			vb.y = dy;
			vb.z = dz;
			nb.len = vb;
			ret.push_back(nb);
		}
	}
	return ret;
}

std::vector<pose> parsePose(const char* fname, model &m){
	using namespace std;
	std::vector<pose> ret;

	string s;
	ifstream f;
	f.open(fname);
	while(!f.eof()){
		getline(f,s);
		if(s.find("s") == 0){
			pose ps;

			getline(f,s);
			stringstream ss(s);
			ss >> ps.toFrames;

			getline(f,s);
			ps.x = 0;
			ps.y = 0;
			ps.z = 0;
			for(int i=0; i<m.bones.size(); i++){
				ps.rx.push_back(0);
				ps.ry.push_back(0);
				ps.rz.push_back(0);
			}

			while(!(s.find("e") == 0)){
				replace(s.begin(), s.end(), ':', ' ');
				replace(s.begin(), s.end(), ',', ' ');
				stringstream ss(s);
				int idx;
				ss >> idx;
				if(idx == 0){
					ss >> ps.rx[idx] >> ps.ry[idx] >> ps.rz[idx] >> ps.x >> ps.y >> ps.z;
				}else{
					ss >> ps.rx[idx] >> ps.ry[idx] >> ps.rz[idx];
				}
				getline(f,s);
			}
			ret.push_back(ps);
		}
	}

	return ret;
}

model parseObj(const char* fname, double scl){
	using namespace std;

	model ret;

	string s;
	ifstream f;
	f.open(fname);
	while(!f.eof()){
		getline(f,s);
		if(s.find("f") == 0){
			tri t;
			int idx;
			s.erase(remove(s.begin(),s.end(),'f'),s.end());
			replace(s.begin(), s.end(), '/', ' ');
			stringstream ss(s);
			ss >> idx; t.a = idx - 1;
			ss >> idx; t.ta = idx - 1;
			ss >> idx; t.na = idx - 1;
			ss >> idx; t.b = idx - 1;
			ss >> idx; t.tb = idx - 1;
			ss >> idx; t.nb = idx - 1;
			ss >> idx; t.c = idx - 1;
			ss >> idx; t.tc = idx - 1;
			ss >> idx; t.nc = idx - 1;
			ret.faces.push_back(t);
		}else if(s.find("vn") == 0){
			vec n;
			s.erase(remove(s.begin(),s.end(),'v'),s.end());
			s.erase(remove(s.begin(),s.end(),'n'),s.end());
			stringstream ss(s);
			ss >> n.x >> n.y >> n.z;
			ret.norms.push_back(n);
			ret.unorms.push_back(n);
		}else if(s.find("vt") == 0){
			uv x;
			s.erase(remove(s.begin(),s.end(),'v'),s.end());
			s.erase(remove(s.begin(),s.end(),'t'),s.end());
			stringstream ss(s);
			ss >> x.u >> x.v;
			ret.uvs.push_back(x);
		}else if(s.find("v") == 0){
			pt p;
			s.erase(remove(s.begin(),s.end(),'v'),s.end());
			stringstream ss(s);
			ss >> p.x >> p.y >> p.z;
			p.x *= scl;
			p.y *= scl;
			p.z *= scl;
			ret.verts.push_back(p);

			vec nv;
			ret.uverts.push_back(nv);
		}
	}
	f.close();
	
	return ret;
}

GLuint LoadRawTex(const char* fname, int width, int height){
    FILE* f = fopen(fname, "rb");
    if(f == NULL){
    	return 0;
    }
    unsigned char* data = (unsigned char*)malloc(width * height * 3);
    fread(data, width * height * 3, 1, f);
    fclose(f);

    GLuint texture;
    glGenTextures(1, &texture);
    glBindTexture(GL_TEXTURE_2D, texture);
    glTexEnvf(GL_TEXTURE_ENV, GL_TEXTURE_ENV_MODE, GL_MODULATE);
    glTexParameterf(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR_MIPMAP_NEAREST);
    glTexParameterf(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
    glTexParameterf(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP);
    glTexParameterf(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_CLAMP);
    gluBuild2DMipmaps(GL_TEXTURE_2D, 3, width, height, GL_BGR, GL_UNSIGNED_BYTE, data);
    free(data);
    return texture;
}

//RENDERERS

int boneFocus = 0;

void brotate(){
	boneFocus = (boneFocus+1)%21;
}

//add size and orientation changes, eventually this should also handle bone deformations
void renderModel(model m, int mode, float r = 1, float g = 1, float b = 1){
	switch(mode){
	case 0://wire
		glDisable(GL_TEXTURE_2D);
		glBegin(GL_LINES);
	    glColor3f(r,g,b);
	    for(int i=0; i<m.faces.size(); i++){
			tri t = m.faces[i];
			glVertex3d(m.uverts[t.a].x,m.uverts[t.a].y,m.uverts[t.a].z); glVertex3d(m.uverts[t.b].x,m.uverts[t.b].y,m.uverts[t.b].z);
			glVertex3d(m.uverts[t.b].x,m.uverts[t.b].y,m.uverts[t.b].z); glVertex3d(m.uverts[t.c].x,m.uverts[t.c].y,m.uverts[t.c].z);
			glVertex3d(m.uverts[t.c].x,m.uverts[t.c].y,m.uverts[t.c].z); glVertex3d(m.uverts[t.a].x,m.uverts[t.a].y,m.uverts[t.a].z);
	    }
	    glEnd();
		break;
	case 1://texture
		glEnable(GL_TEXTURE_2D);
	    glBindTexture(GL_TEXTURE_2D, m.tex);
	    glBegin(GL_TRIANGLES);
	    glColor3f(r,g,b);
	    for(int i=0; i<m.faces.size(); i++){
			tri t = m.faces[i];
			if(m.uverts[t.a].y > 0 && m.uverts[t.b].y > 0 && m.uverts[t.c].y > 0){
				glTexCoord2d(m.uvs[t.ta].u,m.uvs[t.ta].v); glNormal3d(m.unorms[t.na].x,m.unorms[t.na].y,m.unorms[t.na].z); glVertex3d(m.uverts[t.a].x,m.uverts[t.a].y,m.uverts[t.a].z);
				glTexCoord2d(m.uvs[t.tb].u,m.uvs[t.tb].v); glNormal3d(m.unorms[t.nb].x,m.unorms[t.nb].y,m.unorms[t.nb].z); glVertex3d(m.uverts[t.b].x,m.uverts[t.b].y,m.uverts[t.b].z);
				glTexCoord2d(m.uvs[t.tc].u,m.uvs[t.tc].v); glNormal3d(m.unorms[t.nc].x,m.unorms[t.nc].y,m.unorms[t.nc].z); glVertex3d(m.uverts[t.c].x,m.uverts[t.c].y,m.uverts[t.c].z);
			}
	    }
	    glEnd();
		break;
	case 2://no texture
		glDisable(GL_TEXTURE_2D);
	    glBegin(GL_TRIANGLES);
	    glColor3f(r,g,b);
	    for(int i=0; i<m.faces.size(); i++){
			tri t = m.faces[i];
			if(m.uverts[t.a].y > 0 && m.uverts[t.b].y > 0 && m.uverts[t.c].y > 0){
				glNormal3d(m.unorms[t.na].x,m.unorms[t.na].y,m.unorms[t.na].z); glVertex3d(m.uverts[t.a].x,m.uverts[t.a].y,m.uverts[t.a].z);
				glNormal3d(m.unorms[t.nb].x,m.unorms[t.nb].y,m.unorms[t.nb].z); glVertex3d(m.uverts[t.b].x,m.uverts[t.b].y,m.uverts[t.b].z);
				glNormal3d(m.unorms[t.nc].x,m.unorms[t.nc].y,m.unorms[t.nc].z); glVertex3d(m.uverts[t.c].x,m.uverts[t.c].y,m.uverts[t.c].z);
			}
	    }
	    glEnd();
		break;
	}
}

#define ref_delta 0.5
void renderModelRfl(model m, int mode, float r = 1, float g = 1, float b = 1){
	switch(mode){
	case 0://wire
		glDisable(GL_TEXTURE_2D);
		glBegin(GL_LINES);
	    glColor3f(r,g,b);
	    for(int i=0; i<m.faces.size(); i++){
			tri t = m.faces[i];
			glVertex3d(m.uverts[t.a].x,m.uverts[t.a].y,m.uverts[t.a].z); glVertex3d(m.uverts[t.b].x,m.uverts[t.b].y-ref_delta,m.uverts[t.b].z);
			glVertex3d(m.uverts[t.b].x,m.uverts[t.b].y,m.uverts[t.b].z); glVertex3d(m.uverts[t.c].x,m.uverts[t.c].y-ref_delta,m.uverts[t.c].z);
			glVertex3d(m.uverts[t.c].x,m.uverts[t.c].y,m.uverts[t.c].z); glVertex3d(m.uverts[t.a].x,m.uverts[t.a].y-ref_delta,m.uverts[t.a].z);
	    }
	    glEnd();
		break;
	case 1://texture
		glEnable(GL_TEXTURE_2D);
	    glBindTexture(GL_TEXTURE_2D, m.tex);
	    glBegin(GL_TRIANGLES);
	    glColor3f(r,g,b);
	    for(int i=0; i<m.faces.size(); i++){
			tri t = m.faces[i];
			if(-m.uverts[t.a].y-ref_delta < 0 && -m.uverts[t.b].y-ref_delta < 0 && -m.uverts[t.c].y-ref_delta < 0){
				glTexCoord2d(m.uvs[t.ta].u,m.uvs[t.ta].v); glNormal3d(m.unorms[t.na].x,m.unorms[t.na].y,m.unorms[t.na].z); glVertex3d(m.uverts[t.a].x,-m.uverts[t.a].y-ref_delta,m.uverts[t.a].z);
				glTexCoord2d(m.uvs[t.tb].u,m.uvs[t.tb].v); glNormal3d(m.unorms[t.nb].x,m.unorms[t.nb].y,m.unorms[t.nb].z); glVertex3d(m.uverts[t.b].x,-m.uverts[t.b].y-ref_delta,m.uverts[t.b].z);
				glTexCoord2d(m.uvs[t.tc].u,m.uvs[t.tc].v); glNormal3d(m.unorms[t.nc].x,m.unorms[t.nc].y,m.unorms[t.nc].z); glVertex3d(m.uverts[t.c].x,-m.uverts[t.c].y-ref_delta,m.uverts[t.c].z);
			}
	    }
	    glEnd();
		break;
	case 2://no texture
		glDisable(GL_TEXTURE_2D);
	    glBegin(GL_TRIANGLES);
	    glColor3f(r,g,b);
	    for(int i=0; i<m.faces.size(); i++){
			tri t = m.faces[i];
			if(-m.uverts[t.a].y-ref_delta < 0 && -m.uverts[t.b].y-ref_delta < 0 && -m.uverts[t.c].y-ref_delta < 0){
				glNormal3d(m.unorms[t.na].x,m.unorms[t.na].y,m.unorms[t.na].z); glVertex3d(m.uverts[t.a].x,-m.uverts[t.a].y-ref_delta,m.uverts[t.a].z);
				glNormal3d(m.unorms[t.nb].x,m.unorms[t.nb].y,m.unorms[t.nb].z); glVertex3d(m.uverts[t.b].x,-m.uverts[t.b].y-ref_delta,m.uverts[t.b].z);
				glNormal3d(m.unorms[t.nc].x,m.unorms[t.nc].y,m.unorms[t.nc].z); glVertex3d(m.uverts[t.c].x,-m.uverts[t.c].y-ref_delta,m.uverts[t.c].z);
			}
	    }
	    glEnd();
		break;
	}
}

void renderBone(std::vector<bone> skl, int idx = 0){
	if(idx == 0){
		glDisable(GL_TEXTURE_2D);
		glLineWidth(3);
		glBegin(GL_LINES);
		glColor3f(1,0,0);
		pt s = skl[idx].end;
		for(int i=0; i<skl[idx].child.size(); i++){
			pt e = skl[skl[idx].child[i]].end;
			glVertex3d(s.x,s.y,s.z);
			glVertex3d(e.x,e.y,e.z);
			renderBone(skl, skl[idx].child[i]);
		}
		glEnd();
		glLineWidth(1);
	}else{
		pt s = skl[idx].end;
		for(int i=0; i<skl[idx].child.size(); i++){
			pt e = skl[skl[idx].child[i]].end;
			glVertex3d(s.x,s.y,s.z);
			glVertex3d(e.x,e.y,e.z);
			renderBone(skl, skl[idx].child[i]);
		}
	}
}

void renderBone2(std::vector<bone> skl){
	glDisable(GL_TEXTURE_2D);
	glLineWidth(3);
	glBegin(GL_LINES);
	glColor3f(1,0,0);
	for(int i=1; i<skl.size(); i++){
		pt s = skl[skl[i].par].nend;
		pt e = skl[i].nend;
		glVertex3d(s.x,s.y,s.z);
		glVertex3d(e.x,e.y,e.z);
	}
	glEnd();
	glLineWidth(1);
}

#endif
