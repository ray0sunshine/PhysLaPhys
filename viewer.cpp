/*
                                                                                       -s+`                                                                                                             
                                                                                        hNmo`                 .-:/+++ooyhhh+                                                                            
                                                                                        -NNNm:          .:+ydmNNmddmdyo/-``                                                                             
                              /:                                                `os      dNNNN:     ./ydNNNNNNNNNNNNmhyo/-                            `:o/                                              
                             .NNd/                                            `/dm.      dNNNNm``/sdNNNNNNNNNNNNNmdddhhyys-                        .+ymmNo                                              
                             /Mmmmd/                                        .odNm-      :NNNNNMdmNNNNNNNNNNNNNmmmhs/-```                       `:odmmmmmm`                                              
                             /Nmmmmmd/`                                  `/hmNNN-      /NNNNNNNNNNNNNNNNNNNNNmy+-.`                         ./ymmmmmmmmN+                                               
                             /Nmmdddmmd/`                              -smNNmNN/     `oNNNNNNNNNNNNNNNNNNNNNMNmmmddhyo+-                `:odmmmmdddmmmmd`                                               
                             /Ndddddddmmd-                          ./hmNmmNNNs     :dNNNNNNNNNNNNNNNNNNNNNNNmmddddhyys:               `dmmmddddddddddN/                                                
                             +NddddddmmmNd                       `:ymmmmNNNNNN//+sydNNNNNNNNNNNNNNNNNNNNNmdhhydhs/-.``                 sNmmmdddddddddmh                                                 
                             /Nddddddmmmmm                     .odmNmmNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmdhhddmo`                      .NmmmmdhdddddddN:                                                 
                             `odmdddmmmmmm                   `omNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmdmmNNNN/                       yNmmmmydddddddmy                                                  
                               :mhddmmmmmm                  `hNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmmNNNNmmNm:                     :Nmmmmhhddddmdhs.                                                  
                               -NhddmmmmmN`                 oNmmNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmmmmmmo`                  `dmmmmmhhddddm.`                                                    
                              ohmhhdmmmmmN.                 dmmmmNNNmmmmmNNNNNNNNNNNNNNNNNNNNNNNNNNNmmNNmmmmmmddmh:                 +Nmmmmddhdhym+                                                      
                              ymdhhdmmmmmN/                 yNmmmmmNmmmmmmmNNNNNNNNNNNNNNNNNNNNNNmmmmmmmmmmmmmmddhms`              .mmmmmdhdhhyhN-.                                                     
                              +Nmdddmmmmmmh                 -mmmmmmmmmmmmmNmmNNNNNNNNNNNNNNNNNmmmmmmmmmmmmmmmmmmdhhms              ymmmmmhdhhyyhdmd                                                     
                              `odmdddmmmmmN-                 /mmmmmmmmmmmNNNNNmNNNNmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmhyym-            /NmmmmddddddddmN+                                                     
                                :Nhddmmmmmmy                  :Nmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmdhyydo    ./     .mmmmmdhdddddmmmh`                                                     
                               `/NhdhdmmmmmN:                  yNmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmdyysyds   `dm`   `hmmmmdhdddddmm+:`                                                      
                               -NmddddNmmmmmm.         .+yyyyysdNddmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmddmmmmdhyssyym-  .smd   `yNmmmmyhdhdyyN/                                                         
                                mmdddhmmmmmmmh`        dmmNNNNNNNmdddmmmmmmmmmmmmmmmmmmNmmmmmmmmmmmmmdddNmdhhyssyhdmo./shhds  `sNmmmmhhddhhyhm.`                                                        
                                +mmmdddmmmmmmNy`       hmmmmNNNNNNdmddddmmmNmmmmmmmmmmmNmmmmmmmmmddmNNdmmdyyyyhdmNNmhdhyhhN. `sNmmmmhyddhhhhhdmo                                                        
                                  smddhdmmmmmmmy`      -NmmmmmNNNNmdmmmddNmmmmmmmmmmmmNNmmmmmmmNmdmNNmmmhysyyyyhhyyyhhhhhmo `yNmmmmhyhddddddmmN.                                                        
                                  .Nydhhdmmmmmmmh`      /NmmmmmmNNNmmmNdmNmmmmmmmmNNNNmmmmmmmmmmmdNmmdmdsssyyyyyyyyyyyyyms -dmmmmmhsydddddmNmd/                                                         
                                  `ddhyhhdmmmmmdmd.      :NmmmmmNNdhhmNmNmmmmmmmmmmNmmmNNNNNNNmmNmmNmmmmyssssssyyyyyyyhm/ +mmmmmdysyhddhdhdh                                                            
                                  hmhhddhhhmmmmmddm/      -mmmmNNNyydmNNNmmmmmmmmmmmNNNNNNNNNNNNNNNNmdhhyssssssssssyhd+`.hmmmmmdsysydddhhym:                                                            
                                  :Ndddddhhhmmmmmmdms`     :NNmNNmhddmNNNNmmmmmNNNNNNNmNNNNNNNNNNNNNNNNNmddhhhhhhhhm+ `smmmmmdo::yshddhhhhh                                                             
                                   hmdddddyhhmmmmmmdmd-     hNmmdhdmmmmmmmmmmmmmmNNNNNdyhddmmmmmmmmmmmdddddddmmdhhN+`+mmmmmmo:../yyhdddyyhmh`                                                           
                                   :Ndddddhyyhmmmmmmddm+  .ymmmNmdddddmmddmmmmdsymdmNNmhyyyyhdmdddmNmddddhhhyyyyhyhmdmmdmddy/..-oyhhddddddmd                                                            
                                    hmdddddhyyhmmmmmmddmy`/ss+mdhhyyyhmhhmmmmh+//hdyhdmsosyyyyhddddmmmddhhhhddhhhhdmmdhsdddo:`.-yyhddddddmN/                                                            
                                    -Nmdddddhhhhmmmmmmddmd-  `Ndyyssyddhmddmdmyo/+ddyhmo///sdhyoyhddmmmmNmmmdddddddyoyshddh+.`./yyddddddmmm`                                                            
                                     sNddddddhhhhmmmmmmddmm`  ddyysymNmmmymd+syyh+odmmdh-/yyyo:../hddmmmmNNNNNmmNmo/osydhds/``.oyyhdddddmNo                                                             
                                     `mmdddddddddhdmmmmmmdmhs//NhyhmsNmmddmo:-:/:..:ymmm/`.:+/:-`/dddhhdddhhmNNNNhsyyyddhho-`.+yyhdddddmmN.                                                             
                                      /NddddddddddhdmmNmddddmmdmNdNNdNmNhym....````.-+hmh.``....:d-.omhyhhhhyydmhyyhhddhyo:-:syyhdddddmmNs                                                              
                                       hNddddddddddhhmmdddmmmmNNNNNmmNmNmhms.````````.-/ys.````-d/.-:yNmyyyhhyyhdhhhdhyo:-/osyhddddddmmmN-                                                              
                                       .NmddddddddddddddNNmmmmmNNmdmNNmmNmmmy:.``````....//```-hNdmmNNNNmhymmmdhhdmdho/-:osyyhddddddmmmmh                                                               
                                        +NdddddddddmddmdmNNmmmmmNhmmNNmmmmmmmmhs/--.```..`.`.omNNNNNNNNNNNddmmmdhyddhysyyyhhddddddddmmmm:                                                               
                                         hmdddddddmdsohdddmNNmmmmmNNNNNmmmmmNNNmo:--.``.-`-odNNNNNNNmmmNNNNmNmds:-:ohmmmddddddddddmmdho-                                                                
                                         .mmddddddy+/shhhhhhmNmmmmNNNNNNmmmmNNNNNds:.``-+hmNNNNNNNNNNNNNNNNNmms--:/oyhmmdddddddmdho:.                                                                   
                                          :Nddddh+//sdddhhhyhdmNmmmNNNNNNmmdmNNNNNNNdyymNMNNNNNNNNmmNNNNNNmddy++ssyyhhmmdddddmh+-`                                                                      
                                           oNdhs//+ydddddddhhhhdNNmmmNNNNddmmmNNNNNNNNdNNNNmmmmmmNhNNNmmmdhyyyyyso+ydddmddmddmddhs`                                                                     
                                           `hdo///hddddddddddddhdmNmmmNNNmdddddmmmmmmdmddddddddmmNNNNmmdhyyyhhhy///ydddmmmmmmmmmdNy-`                                                                   
                                            `/++shdddddddddddddddddmmmmmNNmdddddmmmmmdmmmmmmmmmNNNmmdhyyyyhhdddh///oddmmdddmmmmdddNNh`                                                                  
                                                -NmmmmmddddddddddddddmmmmmNmmmmmmmmNdhNNNNNNNNNNmdhyyyhhdddddddh///+dmdddmmmmddmmmmmNdy-                                                                
                                                `dNmmmmmmddddddddddddddmmmmmNNmmmmmNmmNNNNNNNmmdhhhhdddddddddddy//ymmmmmmmmmmmmmmdmmmmm+                                                                
                                                 .dNmmmmmmmddddddddddddhdmmmNmmmmmmmmdNNNNmmdhhhdddddddddddddddoshhMNNNNmmmNNmdhdddmmNy`                                                                
                                                  `sNmhdmmmmmmdddddddddddhhhmdhhddddmmmmddhhdddddddddddddddmmmmy+`.mNNmmmmmmdhhddmmmmmNy`                                                               
                                                 `:dNNmdhhddmmNmmddddddddddhhmmmmmmddNmddddddddddddddmmmddd+/-.    `:hmddddhdddmNmmmmmmNd.                                                              
                                               `/hNmNNNNmdhhdmNNNdNNNmdmmmmmmmmNNNmdmmdddddddmmmdmNNNNmdhd-          .shNddddmNNmmmmmmmmmm-                                                             
                                             `ommmmmmmmmmmmmh/dmmdNNNdmmmmmmhhhsydddNmmmdmmmmmmdmNNNNmdod:              dmmmNNmmmmmmmmmmmmN:                                                            
                                            /mmmmmmmmmmdddN/  dmdddmdmNmmmms/+y//hdhmmmmmdmmmmmmmmddh:oh+                -- -dmdddmmmNNNNNNN+                                                           
                                          `smmmmmmmmmdddmm/   hhdd/-ymmNNd+///syshsoomNNmmd-:hddddd+.`hy                      +mmdddddddddmmNy`                                                         
                                         `hmmmmmmmddddmm+`    +dd+   :hmy//::/sooy:::/hddh-  .sddy-``:d`                       `ommdddddddddmmm:                                                        
                                        `dmmmmmmdddmNh/       `hh+.`.+y/:::/oo://oo:::/sh-    :ys```/h.                          `/hmmmddddddmmmy.                                                      
                                       .dmddddddmmNy-          `sds+ohy-.:+o/:::::+o:---oy+.`/ys.`.sh`                              .+dmmddddddmmNy-                                                    
                                 `/ys/:dmddddddmms.              -dyhddyyo:--...--:/oo:.`/hsoys-/+:m.                                 `/dmdddddddmNNh/`                                                 
                                /dmmmmmmdddddmmy.                 s::yyhy/`````````..-://+hdhhs:.`/s                                    .mmddmNNNmmNNNms-                                               
                              :hmmmdddddmdddmm/                   s/`+yhyo```````````````-yhhys```h-                                     /NmdNNNmmmmmNNNNh:                                             
                            .ymdmNmmmddddddmm-                    +s`.syds-```````````````/ydyy.`-d                                       yNmmmmmmmmmmmmmNNh:                                           
                           +dmmNNNNNNmmNmdddN+                    `yo.:yhho```````````````.shhy:`ss                                       `hNmmmmmmmmmmmmmmmmy-                                         
                          ommmmmmNNNNmmmmmmmN:                     `/y++ydy/.......````````/hdho.d:                                        `ommmmmmmmddddddmmmmo`                                       
                         `NmmmdhddmNNNmmmmNd:                        `oyhdds:---------------ydhh-yo                                          -smmmmdddddddddddmmd:                                      
                          hmhhhddmddmNmmmmy.                           -hmdho---------------oddd:-h/                                           .+ydmmdddddddddddmms`                                    
                         /mddddddddddmmmd/                 :sys/.`./ossodNddy+...-----------:ymd+.-h:                                             ./shmmdddddddddmmd:                                   
                       `smdddddddddddddN/                .ymmmmmmdmNmmdmmy:ddy:.....:........odds..-s/`                                              `-+hmmddddddddmmo`./yy.                            
                      -dNdddddddmdddmmdmd        .so+:.`:dNmmmmmdmmmmmmdd:./dds.....//.......:hdh....os-                                                `-odmdddddddmNdmNMNm:                           
                     -mmNmdNmNdmNmdmdmmm+      `:dmdmmddNmmmmmmmmmddmmmd+-..+dh+.....s-.......ydh-....:yo`                                                 `+dmdddddmmNNNMNmm+                          
                    .mmmNmmNNNmNNdmdddm:     .+symdmmmmmmmmNNmmmmmmmmdms-....ohy:....-:.......odh/.....-+y:                                                  `+NmddmmmNNNmdhdmo`                        
                    sNmmmmmmmmmmmmNddm-    .os//ymdmmmmmmmmmmmmmmmmmmmh-......shs.....-.......:hho...-...-ss.                                               `:sNNNNNNNNmdhdddhmy                        
                    hmmmdmddmdddmdmmms    -h+:/ohmmmmmmmmmmmmmmmmmmmmm/.......-sh+.............yhs........./y+`               `-+y:                         yNMMMNNNNmdhdmmddddd                        
                    .+yhdddhhddd+`-+/`    `:/+hdNNmdddmmmmmmmmmmmmmNNms+//:-...-yh:............+hs...........oy-`         `./ydmmms`                        :mNMNmmdhdmmdddmmdN/                        
                         ``   `               -odsshdmmmmmmmmmmmmmmmmmmmmmmdy+-./yy............:hy-.........../yyyyyso/-:shmmmdddmdo+:`                      .hmhhhdmmdddmNdhhms                        
                                           .+ydd:./+sdmmmmmmmmmmmmmmmmmmmmmmmmd+:oho.....-.....-yy/...........-.sdddddNNNmmmmmmmmmo-.+ys                      `omdddddmNmmmmdddh                        
                                         .ss+yyho++soohmNNhyhhhdmmmmmmmmmdddmmmmmddy/....-......yo+-..........-/ydddmmmmmmmmmmmmdhsyss+.                        :ddmmmmmmmmmmmm:                        
                                         dsoydddoossoodNmyoydmmh+ohdddhysyhdmmmmmmm-o-.-.-......h:./-.......-+yyhhmmmmmmmmmmmmmdmdy+.                            `+odNmmmmmNNNd                         
                                         `.-.`oyssyshMmmmmdddh+-----::osyhddmmmmmmm:o+.-.-......y-`-/.....-/yhhhmmmmmmmmmmmmmmmmm-                                 sNmmmmmNNmmN-                        
                                               `  /yyysddddy+-------::+hdddmmNmmmmmsos.-.-.-....s:..+-..-+yyyhmdmmmmmdddddddddmN:                                 yNmmmmmmdddddm.                       
                                                 :N/:soody/:------:/+sddddhmNmmmmmmhsy--.-.-----y+://+++sssyhdmdmmmmmmmmmmmmmmhm/                                /Nmmmddddddddddm:                      
                                                  -osmhs+::/++osyydddhdmdmymmmmmmmmNmd:-.-------y+/+shhysyhdddmdmmmmmmmmmmmmdyo:yy`                              /mddddddddddddddm/                     
                                                   /dmyyhhdddmmmmmmddhdmddohmmddmmmNmmmy+/-----/yoshhhhdhdddddmdmmmmmmmmmmmhosooyh+                              .mddddddddmhdmddms                     
                                                 `hddddmmmmmmmmmmmdydmmmdh::so++ohmmmmmmhhyyyyyhhhdhhhhhdddddddhdddddmmmmmhshmo:`                                -mddNydmddmddmmmd`                     
                                                .dNmmmmmmmmdddddddyhmmmmdh/::+:oysmNmmmNdmmdddddyydddddhddddddmhdddyhhhmho+//d/                                  /mddN/`smmmmmmmN-                      
                                               -ddhhhhhddddddddddhyhmmmmdh/-::/:smmNmmmmmmmddmh+osdddddddmmdddmddyssss///::::/d.                                 `ymdmh `hNNmmmmN:                      
                                              -mddmmmmmmmmmmmmmmmhhhmmmmmy/.::-sNNmNmmmmdNyo+/ohssddddddhhdddddyo+/::y::::::::oh                                  `+mmd.dmmNmmmmN/                      
                                             `dNmmmmmmmmmmmmmmmmhhmdhmmmmho-::ysNNhssyshdy.   `:hhdmmdddoodddyhhdhdho+/:::-.::-y:                                   -/`:NmmMmmNNh`                      
                                             sNmdmmmmmmmmmmmmmmdhmmmhmmmmhy.:h/ -+hyoood-`      .ommmddysy+//:/ddmmddyo/::-..-`-h`                                     `:oNNmNN+`                       
                                            :Nmddmmmmmmmmmmmmmdydmmmdhmmmdh+y-    .oy+h/`   `  ` `dmmds+++/::::ddddmmmdyyo+:.```o/                                       ymmmNs                         
                                           .mmmddmmmmmmmmmmmmmyhmmmmmhdmmddd`       ./- ```````` `/hhmo//+:::::hdmmdmmmmdddhys+::h`                                      .oNmN.                         
                                           ymmdddmmmmmmmmmmmmhymmmmmmhhmmmm:                       ``ss:::-:::/hmmmmhdmmmmmmmmdhyh+                                       `yy/                          
                                          /NmmdddmmmmmmmddddhydmmmmmmdymNm:                          `sy-----:ydmmmmmdhmmmmmmmmmmdm`                                                                    
                                          dmmddddmmmmmdddddhyhmmmmmmmdymm-                            `yo...-ohmmmmmmmdhddmmmmmdmmmo                                                                    
                                         .Nmmdddddmmmddddddyyddmmmmmmdhm-                              `y+``/hdmmmmmmmdhhhdhhhhddmmm.                                                                   
                                         :MmmdddddmmddddddyyddmmmmmmmNy-                                `y+:hhmmmmmmmddmdhdmmddhhhdms                                                                   
                                         /Nmmddddddddddddhyhddmmmmmmm/                                   `hdydmmmmmmdhmmmdydmmmdddhhm.                                                                  
                                         :NdmdddddddddddhyydddmmmmNh.                                     `hdmmmmmmmhmmmmmdydmmdddddmy                                                                  
                                         .NdmdddddddddddyydddddmmNy`                                       `hNmmmmmhdmmmmmmdydmmddddmN-                                                                 
                                          mdmddddddddddyyhddddmmNh`                                         `sNmmmhhmmmmmmmmdydmmddddms                                                                 
                                          ymddddddddddhyhdddddmNm.                                            +NmdhmmmmmmmmmmmydmmddddN`                                                                
                                          dmddddddddddyhddddddmN-                                              /Nhhmmmmmmmmmmmmydmddddms                                                                
                                         /NddddddddddhhddddddmNo                                                :ddmmmmmdmmmmmmmyhmddddN/                                                               
                                       `:mdddddddddhyydddddddNh                                                  .hmmmmmddddmmmmmyhmddddm/                                                              
                                     .+dmdddddddddhyyhddddddmh`                                                    /dmmmdddddddmmmyhdddddms`                                                            
                                  `:ymmddddddddddhyyyddddddms                                                       `ommddddddddddmyydddddmm+`                                                          
                                -smmddddddddddddhyyhdddddmd:                                                          .ymdddddddddddyyddddddmd/                                                         
                             `/dNmddddddddddddmdhhdddddmd/                                                              :mmddddddddddhyhdddddmmd:                                                       
                            +mmdddddddddddddmmdmmmmmmNh/                                                                 `sNdddddddddddhhdddddmmmy.                                                     
                          .hmdddddddddddddmddmmmmmmNs.                                                                     -dmddddddddddddmdddddmmmo`                                                   
                         -mmddddddddddddmdhdmmmmmNd-                                                                        `+mdddddmmmmmmdmmddddddmd/                                                  
                        .mNdddddddddddddhhmmmmmmNo`                                                                           -dmmmmmmmmmmmdmmddddddmmy.                                                
                        yNmddddddddddhyhdmmmmmNd:                                                                              .dmmmmmmmmmmmmdmdddddddmm+`                                              
                       -NmdddddddddhyyhmmmmmNNo`                                                                                .dNmmmmmmmmmmmdmmdddddddmh-                                             
                       sNmdddddddhyyhdmmmmmNy.                                                                                   `ommmmmmmmmmmdhdmddddddddmo`                                           
                      `mmdddddddyyydmmmmmmy-                                                                                       .odmmmmmmmdmmhhdddddddddmd/                                          
                      oNddddddhyyhmmmmmds-                                                                                           .+dmmmdddddmdyddddddddddmy-                                        
                     -Nmdddddhyhdmmmmy/.                                                                                               `:ymmdddddddhhdddddddddmdo`                                      
                    .dmddddmhydmmmh+.                                                                                                     -sdmddddddhyddddddddddmd/`                                    
                   `hmmdddmhhmmds-`                                                                                                         .odmddddddhhdddddddddmmh:                                   
                  .dmdddddhdmmo.                                                                                                              .ymddddddhhddddddddddmmy-                                 
                 :dmdddmdhmmy.                                                                                                                  +mdddddddhdddddddddddmm+`                               
                /mmdddmdhmN+                                                                                                                     +mdddddddddddddddddddmmy.                              
               +NmdddmhdmNy                                                                                                                       smddddddddhdddddddddddmd.                             
              :Nmdddmddmmm.                                                                                                                        yNddddddddhdddddddddddmd`                            
             -mmmmmmmmmmN/                                                                                                                         `smdddddddddhddddddddddNy                            
            /mNmmmmmmmmmo                                                                                                                            /mmddddddddhddddddddddN+                           
          `sNmmmmmmmmmh:                                                                                                                              .ymddddddddhdddddddddmm`                          
         -dNmmmmmmmmNo                                                                                                                                  -ymddddddmdhmdddddddNo                          
       `oNmmmmmmmmmNy                                                                                                                                     -ymmddddmmhmddddddmN.                         
      -dNmmmmmmmmmmN.                                                                                                                                       .smmmdddmhddddddmNs                         
     +NmmmmmmmmmmmNy                                                                                                                                          .ommmddmdmmddddmN.                        
   .hNmddmmhdmmmmmN-                                                                                                                                            `ommmdmdmmdddmNy                        
  /mmddddmhdmmmmmNh                                                                                                                                               `ommdmmmmdddmN-                       
 -NmddddmhmmmmmmmN-                                                                                                                                                 `ommmmmmddmmh                       
 smdddddhdmmmmmmNy                                                                                                                                                    .ymmmmmddmN/                      
 dmmdddydmmmmmmNd`                                                                                                                                                      oNmmdmmmmm`                     
.myyyyyydmmmmmNh.                                                                                                                                                        +Nmmdmmmmy                     
/mhhyyyyyhdmmm+`                                                                                                                                                          sNdmdmmmNo                    
sdhhhhhhhhddo.                                                                                                                                                            `dmdmdmmmNs                   
mhhhhhhhdh/`                                                                                                                                                               -NmdmmmmmNy`                 
hdhhhhdh/`                                                                                                                                                                  smddmmmmmNd:                
`-+syy/`                                                                                                                                                                    `mmmmmmmmmmmo`              
    `                                                                                                                                                                        :mmmmmmmmmmNh.             
                                                                                                                                                                              -hmmmmmmmmmmm/            
                                                                                                                                                                               `:hmmmmmmmmmNy.          
                                                                                                                                                                                 `ymmmmmmmddmd:         
                                                                                                                                                                                  .mmmmmmmddddms.       
                                                                                                                                                                                   sNmmmmddddddmd/`     
                                                                                                                                                                                   .Nmmmmdhddddddmy-    
                                                                                                                                                                                    sNdddmdyddddddmmo`  
                                                                                                                                                                                    .NmdddmdydddddddNs  
                                                                                                                                                                                     oNddddmdydmdddddN: 
                                                                                                                                                                                     `hNmdddmdhmmddddms 
                                                                                                                                                                                      `yNmmddmmhhhhhhhm`
                                                                                                                                                                                        +mmmdmdyyyyyyyN-
                                                                                                                                                                                         `+dmNhhhhhhhhmo
                                                                                                                                                                                            /hmdhhhhhhdm
                                                                                                                                                                                              -ymdhhhhdm
                                                                                                                                                                                                .smmdy/`

LIFE FIBRE SYNCHRONIZATION! KAMUI SENKETSU!
*/

#include "viewer.hpp"
#include <iostream>
#include <GL/gl.h>
#include <GL/glu.h>
#include <gdk/gdk.h>

#include "datastruct.hpp"
#include "terrain.hpp"
#include "env.hpp"
#include "particle.hpp"

//camera movement vars
#define camDefRX 20
#define camMinRX -3
#define camMaxRX 60
#define camDefRY 0
#define camDamp 32
#define camMaxZoom -10
#define camMinZoom -100
#define camDefZoom -40
#define camZoomTick 2

#define charMoveSpeed 1.666
#define jumpVelo 2.3
#define jumpGrav 0.2

bool mr, ml, mf, mb;
double avx=0,avy=0,avz=0;

bool initialized = false;

//3d assets
model riv;
model swrh;
model swlh;

//character position and velo
double charx,chary,charz;
double camVX=0,camVY=0,camVZ=0;
double cvx=0,cvy=0,cvz=0;
double cturn=0;

bool skeleton = false;

Viewer::Viewer(){
  Glib::RefPtr<Gdk::GL::Config> glconfig;
  glconfig = Gdk::GL::Config::create(Gdk::GL::MODE_RGB | Gdk::GL::MODE_DEPTH | Gdk::GL::MODE_DOUBLE);
  if(glconfig == 0){std::cerr << "Unable to setup OpenGL Configuration!" << std::endl; abort();}
  set_gl_capability(glconfig);
  add_events(Gdk::POINTER_MOTION_MASK | Gdk::BUTTON_PRESS_MASK | Gdk::BUTTON_RELEASE_MASK | Gdk::VISIBILITY_NOTIFY_MASK | Gdk::SCROLL_MASK);
  init();
}

Viewer::~Viewer(){}

GLuint skyTex = 0;

GLuint kisaragiTex = 0;
GLuint ryukoTex = 0;
bool supersaiyan = false;

void Viewer::init(){
  initialized = true;

  mouselock = false;
  mousewarp = false;
  camRX = camDefRX;
  camRY = camDefRY;
  camX = 0;
  camY = -8;
  camZ = 0;
  camZoom = camDefZoom;

  showriv = false;
  lightX = 8.0;
  lightY = 24.0;
  lightZ = 8.0;

  charx = 0;
  chary = 0;
  charz = 0;

  initGround();
  initWater();
  initShade();
  initLeaf();
  initCloth();
  
  for(int i=0; i<25; i++){
    addPlant(dRand(0,50),dRand(0,50));
  }

  for(int i=0; i<75; i++){
    addPlant(dRand(-150,150),dRand(-150,150));
  }
}

int randi(int min, int max){
  return rand() % max + min;
}

bool Viewer::update(){
  if(mr){
    cvx = charMoveSpeed;
    if(mstate != run){cframe = 99;}
    mstate = run;
  }else if(ml){
    cvx = -charMoveSpeed;
    if(mstate != run){cframe = 99;}
    mstate = run;
  }else{
    cvx = 0;
  }

  if(mf){
    cvz = -charMoveSpeed;
    if(mstate != run){cframe = 99;}
    mstate = run;
  }else if(mb){
    cvz = charMoveSpeed;
    if(mstate != run){cframe = 99;}
    mstate = run;
  }else{
    cvz = 0;
  }

  if(cvz == 0 && cvx == 0){
    if(mstate == run){cframe = 99;}
    mstate = idle;
  }

  avz += 0.3*(cos(rad(-camRY))*cvz + sin(rad(camRY))*cvx);
  avx += 0.3*(sin(rad(-camRY))*cvz + cos(rad(camRY))*cvx);

  if(!(mr||ml||mf||mb)){
    avz *= 0.7;
    avx *= 0.7;
  }else if(avx != 0 || avz != 0){
    double dslow = charMoveSpeed/sqrt(avx*avx + avz*avz);
    avx *= dslow;
    avz *= dslow;
  }

  if(mr||ml||mf||mb){
    cturn = atan2(avx,avz);
  }

  charx += avx;
  charz += avz;

  if(chary > 0){
    avy -= jumpGrav;
    mstate = jump;
  }

  chary += avy; //do special checks

  if(chary < 0){
    chary = 0;
    avy = 0;
    mstate = idle;
  }

  shiftShade(avx,0);
  shiftShade(0,avz);

  if(showriv){
    arotate(riv);
    updateBones(riv,charx,chary,charz,cturn);
    updateBones(swrh,charx,chary,charz,cturn);
    updateBones(swlh,charx,chary,charz,cturn);

    //add fire particles
    //void addPart(double x, double y, double z, double vx, double vy, double vz, int life, ptype tp, float r, float g, float b)
    vec uvt;
    if(supersaiyan){
      double fvelo = 0.1;
      double flife = 50;
      for(int i=0; i<5; i++){
        uvt = swrh.uverts[randi(0,swrh.uverts.size()-1)];
        addPart(uvt.x,uvt.y,uvt.z,dRand(-fvelo,fvelo),dRand(-fvelo,fvelo),dRand(-fvelo,fvelo),flife,flame,1,dRand(0,0.8),0);
        uvt = swrh.uverts[randi(0,swrh.uverts.size()-1)];
        addPart(uvt.x,uvt.y,uvt.z,dRand(-fvelo,fvelo),dRand(-fvelo,fvelo),dRand(-fvelo,fvelo),flife,flame,1,dRand(0.8,1),dRand(0.5,0.7));
        uvt = swlh.uverts[randi(0,swrh.uverts.size()-1)];
        addPart(uvt.x,uvt.y,uvt.z,dRand(-fvelo,fvelo),dRand(-fvelo,fvelo),dRand(-fvelo,fvelo),flife,flame,1,dRand(0.8,1),dRand(0.5,0.7));
        uvt = swlh.uverts[randi(0,swrh.uverts.size()-1)];
        addPart(uvt.x,uvt.y,uvt.z,dRand(-fvelo,fvelo),dRand(-fvelo,fvelo),dRand(-fvelo,fvelo),flife,flame,1,dRand(0.8,1),dRand(0.5,0.7));
      }

      double sm_col;
      fvelo = 0.03;
      flife = 300;
      for(int i=0; i<20; i++){
        sm_col = dRand(0.9,1);
        uvt = swrh.uverts[randi(0,swrh.uverts.size()-1)];
        addPart(uvt.x,uvt.y,uvt.z,dRand(-fvelo,fvelo),dRand(-fvelo,fvelo),dRand(-fvelo,fvelo),flife,smoke,sm_col,sm_col,sm_col);
        uvt = swlh.uverts[randi(0,swrh.uverts.size()-1)];
        addPart(uvt.x,uvt.y,uvt.z,dRand(-fvelo,fvelo),dRand(-fvelo,fvelo),dRand(-fvelo,fvelo),flife,smoke,sm_col,sm_col,sm_col);
      }
    }else{
      double fvelo = 0.05;
      double flife = 40;
      for(int i=0; i<5; i++){
        uvt = swrh.uverts[randi(0,swrh.uverts.size()-1)];
        addPart(uvt.x,uvt.y,uvt.z,dRand(-fvelo,fvelo),dRand(-fvelo,fvelo),dRand(-fvelo,fvelo),flife,flame,1,dRand(0,0.2),0);
        uvt = swrh.uverts[randi(0,swrh.uverts.size()-1)];
        addPart(uvt.x,uvt.y,uvt.z,dRand(-fvelo,fvelo),dRand(-fvelo,fvelo),dRand(-fvelo,fvelo),flife,flame,1,dRand(0.3,0.5),dRand(0.3,0.5));
        uvt = swlh.uverts[randi(0,swrh.uverts.size()-1)];
        addPart(uvt.x,uvt.y,uvt.z,dRand(-fvelo,fvelo),dRand(-fvelo,fvelo),dRand(-fvelo,fvelo),flife,flame,1,dRand(0,0.2),0);
        uvt = swlh.uverts[randi(0,swrh.uverts.size()-1)];
        addPart(uvt.x,uvt.y,uvt.z,dRand(-fvelo,fvelo),dRand(-fvelo,fvelo),dRand(-fvelo,fvelo),flife,flame,1,dRand(0.3,0.5),dRand(0.3,0.5));
      }
    }
  }

  invalidate();
  return true;
}

void Viewer::invalidate(){
  Gtk::Allocation allocation = get_allocation();
  get_window()->invalidate_rect(allocation, false);
}

void Viewer::on_realize(){
  Gtk::GL::DrawingArea::on_realize();
  Glib::RefPtr<Gdk::GL::Drawable> gldrawable = get_gl_drawable(); if (!gldrawable) return; if (!gldrawable->gl_begin(get_gl_context())) return;

  glEnable(GL_DEPTH_TEST);
  glEnable(GL_BLEND);
  glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
  glClearColor(0.4, 0.4, 0.4, 0);
  gldrawable->gl_end();
}

bool Viewer::on_configure_event(GdkEventConfigure* e){
  Glib::RefPtr<Gdk::GL::Drawable> gldrawable = get_gl_drawable(); if (!gldrawable) return false; if (!gldrawable->gl_begin(get_gl_context())) return false;

  glMatrixMode(GL_PROJECTION);
  glLoadIdentity();
  glViewport(0, 0, e->width, e->height);
  gluPerspective(40, (GLfloat)e->width/(GLfloat)e->height, 0.1, 2000.0);

  scrCX = e->width/2;
  scrCY = e->height/2;

  glMatrixMode(GL_MODELVIEW);
  gldrawable->gl_end();
  return true;
}

#define cam_Damp 0.666
#define cam_Acc 0.16669

bool Viewer::on_expose_event(GdkEventExpose*){
  Glib::RefPtr<Gdk::GL::Drawable> gldrawable = get_gl_drawable(); if (!gldrawable) return false; if (!gldrawable->gl_begin(get_gl_context())) return false;

  // Clear the screen
  glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);

  // Modify the current projection matrix so that we move the camera away from the origin.  We'll draw the game at the origin, and we need to back up to see it.
  glMatrixMode(GL_PROJECTION);
  glPushMatrix();
  glTranslated(0, 0, camZoom);
  glRotated(camRX, 1, 0, 0);
  glRotated(camRY, 0, 1, 0);

  camVX += (charx - camX) * cam_Acc;
  camVY += (chary+10 - camY) * cam_Acc;
  camVZ += (charz - camZ) * cam_Acc;

  camVX *= cam_Damp;
  camVY *= cam_Damp;
  camVZ *= cam_Damp;

  camX += camVX;
  camY += camVY;
  camZ += camVZ;

  glTranslated(-camX, -camY, -camZ);
  //glTranslated(camX-charx, camY-chary, camZ-charz);

  // Reset the matrix to identity
  glMatrixMode(GL_MODELVIEW);
  glLoadIdentity();

  //draw sky box
  glEnable(GL_TEXTURE_2D);
  glBindTexture(GL_TEXTURE_2D, skyTex);
  glColor3f(1,1,1);
  glBegin(GL_QUADS);
  glNormal3d(0,0,1);
  glTexCoord2d(0,1); glVertex3d(-600,500,-598);
  glTexCoord2d(1,1); glVertex3d(570,500,-598);
  glTexCoord2d(1,0.2); glVertex3d(570,-10,-598);
  glTexCoord2d(0,0.2); glVertex3d(-600,-10,-598);
  glNormal3d(0,0,-1);
  glTexCoord2d(1,1); glVertex3d(-600,500,598);
  glTexCoord2d(0,1); glVertex3d(570,500,598);
  glTexCoord2d(0,0.2); glVertex3d(570,-10,598);
  glTexCoord2d(1,0.2); glVertex3d(-600,-10,598);
  glNormal3d(1,0,0);
  glTexCoord2d(1,1); glVertex3d(-598,500,-600);
  glTexCoord2d(0,1); glVertex3d(-598,500,600);
  glTexCoord2d(0,0.2); glVertex3d(-598,-10,600);
  glTexCoord2d(1,0.2); glVertex3d(-598,-10,-600);
  glNormal3d(-1,0,0);
  glTexCoord2d(0,1); glVertex3d(568,500,-600);
  glTexCoord2d(1,1); glVertex3d(568,500,600);
  glTexCoord2d(1,0.2); glVertex3d(568,-10,600);
  glTexCoord2d(0,0.2); glVertex3d(568,-10,-600);
  glEnd();

  lighting();
  if(showriv){
    if(skeleton){
      renderBone2(riv.bones);
      renderModel(riv,0);
    }else{
      renderModel(riv,1);
    }
    
    renderModel(swrh,2,0.5,0,0);
    renderModel(swlh,2,0.5,0,0);
    renderModelRfl(riv,1);
    renderModelRfl(swrh,2,0.5,0,0);
    renderModelRfl(swlh,2,0.5,0,0);
  }

  lightingNoSpec();
  simPlant(charx,chary+4,charz);
  simCloth(charx,chary+14,charz);
  simPart(charx,chary+10,charz);

  drawCloth();
  drawPlants();
  drawGround();
  drawWater(charx,charz);
  drawPart();

  lightingShade();
  std::vector<vct> mps;
  for(int i=0; i<riv.uverts.size(); i++){
    vct mp;
    mp.x = riv.uverts[i].x;
    mp.y = riv.uverts[i].y;
    mp.z = riv.uverts[i].z;
    mps.push_back(mp);
  }
  for(int i=0; i<swlh.uverts.size(); i++){
    vct mp;
    mp.x = swlh.uverts[i].x;
    mp.y = swlh.uverts[i].y;
    mp.z = swlh.uverts[i].z;
    mps.push_back(mp);
  }
  for(int i=0; i<swrh.uverts.size(); i++){
    vct mp;
    mp.x = swrh.uverts[i].x;
    mp.y = swrh.uverts[i].y;
    mp.z = swrh.uverts[i].z;
    mps.push_back(mp);
  }
  shadow(mps,lightX + charx, lightY + chary , lightZ + charz, charx, charz);

  //We pushed a matrix onto the PROJECTION stack earlier, we need to pop it.
  glMatrixMode(GL_PROJECTION);
  glPopMatrix();

  //double buffering
  gldrawable->swap_buffers();
  gldrawable->gl_end();
  return true;
}

void Viewer::lighting(){
  glShadeModel(GL_SMOOTH);
  glLightModeli(GL_LIGHT_MODEL_COLOR_CONTROL, GL_SEPARATE_SPECULAR_COLOR);

  GLfloat mat_ambient[] = {0.25,0.25,0.25,1};
  GLfloat mat_diffuse[] = {0.4,0.4,0.4};
  GLfloat mat_specular[] = {0.775,0.775,0.775};
  GLfloat shine[] = {77};
  glMaterialfv(GL_FRONT, GL_AMBIENT, mat_ambient);
  glMaterialfv(GL_FRONT, GL_DIFFUSE, mat_diffuse);
  glMaterialfv(GL_FRONT, GL_SPECULAR, mat_specular);
  glMaterialfv(GL_FRONT, GL_SHININESS, shine);

  GLfloat light_position[] = {lightX + charx, lightY + chary, lightZ + charz, 1};
  glLightfv(GL_LIGHT0, GL_POSITION, light_position);
  glLightf(GL_LIGHT1, GL_SPOT_CUTOFF, 10.0);
  glLightf(GL_LIGHT1, GL_SPOT_EXPONENT, 2.0);
  glEnable(GL_LIGHTING);
  glEnable(GL_LIGHT0);
  glEnable(GL_COLOR_MATERIAL);

  /*glBegin(GL_TRIANGLES);
  glVertex3f(lightX + charx - 0.2, lightY + chary - 0.2, lightZ + charz);
  glVertex3f(lightX + charx + 0.2, lightY + chary - 0.2, lightZ + charz);
  glVertex3f(lightX + charx, lightY + chary + 0.2, lightZ + charz);
  glEnd();*/
}

void Viewer::lightingNoSpec(){
  GLfloat mat_specular[] = {0,0,0};
  glMaterialfv(GL_FRONT, GL_SPECULAR, mat_specular);
}

void Viewer::lightingShade(){
  GLfloat mat_ambient[] = {0,0,0,1};
  GLfloat mat_diffuse[] = {0,0,0};
  GLfloat mat_specular[] = {0,0,0};
  GLfloat shine[] = {0};
  glMaterialfv(GL_FRONT, GL_AMBIENT, mat_ambient);
  glMaterialfv(GL_FRONT, GL_DIFFUSE, mat_diffuse);
  glMaterialfv(GL_FRONT, GL_SPECULAR, mat_specular);
  glMaterialfv(GL_FRONT, GL_SHININESS, shine);
}

bool Viewer::on_button_press_event(GdkEventButton* e){
  return true;
}

bool Viewer::on_button_release_event(GdkEventButton* e){
  return true;
}

bool Viewer::on_motion_notify_event(GdkEventMotion* e){
  if(mousewarp){
    mousewarp = false;
  }else{
    if(mouselock){
      if(!(e->x == scrX + scrCX && e->y == scrY + scrCY)){
        camRY += (e->x - scrCX)/camDamp;
        camRX += (e->y - scrCY)/camDamp;

        if(camRX > camMaxRX){
          camRX = camMaxRX;
        }else if(camRX < camMinRX){
          camRX = camMinRX;
        }

        if(camRY > 360){
          camRY = camRY - 360;
        }else if(camRY < 0){
          camRY = camRY + 360;
        }

        gdk_display_warp_pointer(gdk_display_get_default(), gdk_screen_get_default(), scrX + scrCX, scrY + scrCY);
        mousewarp = true;
      }
    }
  }
  return true;
}

bool Viewer::on_scroll_event(GdkEventScroll *e){
  if(e->direction == GDK_SCROLL_UP){
    camZoom += camZoomTick;
    if(camZoom > camMaxZoom){
      camZoom = camMaxZoom;
    }
  }else{
    camZoom -= camZoomTick;
    if(camZoom < camMinZoom){
      camZoom = camMinZoom;
    }
  }
  return true;
}

void Viewer::keyHandle(GdkEventKey *e){
  switch(e->keyval){
  case '1':
    mouselock = !mouselock;
    gint x,y;
    if(mouselock){
      gdk_display_warp_pointer(gdk_display_get_default(), gdk_screen_get_default(), scrX + scrCX, scrY + scrCY);
      gdk_window_set_cursor(gdk_window_at_pointer(&x,&y),gdk_cursor_new(GDK_BLANK_CURSOR));
    }else{
      gdk_window_set_cursor(gdk_window_at_pointer(&x,&y),gdk_cursor_new(GDK_TCROSS));
    }
    break;
  case '2':
    riv = parseObj("models/ryuko_body.obj", 0.12);
    ryukoTex = LoadRawTex("textures/ryuko.bin",2048,2048);
    kisaragiTex = LoadRawTex("textures/kisaragi.bin",2048,2048);
    riv.tex = ryukoTex;

    swrh = parseObj("models/blade_rh.obj", 0.12);
    swlh = parseObj("models/blade_lh.obj", 0.12);
    riv.bones = parseSkl("models/ryuko_skl.txt", 0.12);
    bind(riv);
    riv.poses = parsePose("models/ryuko_pose.txt",riv);
    updateBones(riv,charx,chary,charz,0);

    swrh.bones = parseSkl("models/ryuko_skl.txt", 0.12);
    bind(swrh);
    swrh.poses = parsePose("models/ryuko_pose.txt",riv);
    updateBones(swrh,charx,chary,charz,0);

    swlh.bones = parseSkl("models/ryuko_skl.txt", 0.12);
    bind(swlh);
    swlh.poses = parsePose("models/ryuko_pose.txt",riv);
    updateBones(swlh,charx,chary,charz,0);

    terrainTex = LoadRawTerrainTex("textures/terrain.bin",4096,4096);
    skyTex = LoadRawTex("textures/sky.bin",2048,2048);
    showriv = true;
    break;
  case 'x':
    waveTrans = !waveTrans;
    break;
  case 'z':
    if(showriv){
      supersaiyan = !supersaiyan;
      if(supersaiyan){
        riv.tex = kisaragiTex;
        double svelo;
        double slife;
        vec uvt;
        for(int i=0; i<riv.uverts.size(); i++){
          svelo = dRand(0.5,1.5);
          slife = randi(60,80);
          uvt = riv.uverts[i];
          addPart(uvt.x,uvt.y,uvt.z,dRand(-svelo,svelo),dRand(-svelo,svelo),dRand(-svelo,svelo),slife,spark,1,dRand(0.5,1),dRand(0.3,0.5));
        }
      }else{
        riv.tex = ryukoTex;
      }
    }
    //brotate();
    break;
  case 'm':
    columns[5][5].v += 3;
    columns[6][5].v += 3;
    columns[5][6].v += 3;
    columns[6][6].v += 3;
    break;
  case 't':
    wireCloth = !wireCloth;
    //camY -= 0.1;
    break;
  case 'g':
    shading = !shading;
    //camY += 0.1;
    break;
  case 'w':
    mf = true;
    break;
  case 'a':
    ml = true;
    break;
  case 's':
    mb = true;
    break;
  case 'd':
    mr = true;
    break;
  case 'r':
    stemOnly = !stemOnly;
    //chary += 0.1;
    //lightY += 0.1;
    break;
  case 'f':
    skeleton = !skeleton;
    //chary -= 0.1;
    //lightY -= 0.1;
    break;
  case ' ':
    if(chary == 0){
      avy = jumpVelo;
    }
    break; 
  }
}

void Viewer::keyHandleup(GdkEventKey *e){
  switch(e->keyval){
  case '1':
    break;
  case '2':
    break;
  case 'x':
    break;
  case 'z':
    break;
  case 'm':
    break;
  case 't':
    break;
  case 'g':
    break;
  case 'w':
    mf = false;
    break;
  case 'a':
    ml = false;
    break;
  case 's':
    mb = false;
    break;
  case 'd':
    mr = false;
    break;
  case 'r':
    break;
  case 'f':
    break;
  }
}

