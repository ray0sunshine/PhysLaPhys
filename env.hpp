/*
                         ``-:/++//ooossssssssyyyyyyyysssyysso:`   .-/+++++ooo++/:::++:.`````                     -+ossssyyyyyyysooooooooooooo+++/:---::/++oooooossssooosssssooosssoo++//::-``````.---..`
  ``````````````          ```.:/++++++oooossssssssssyssssssss+.`` ``://///++++//:::/+/.`                        `/oossosyyyyyys++oooooo++++++//::---::++oosssssssssoosssssooossoo++///:-`    ``......```
                            ```.://///++oooooossssssssssosssss+-.````-::::://///:--:++-`                        .+oosoosyyyyyy++++++++++++///::----:/++osssssssssoosssssooooooo++//:::.     ````````````
                              ```.-/////++ooooooosssooossoosssso:..````---:-:/:::-../+:`                        -+oosooyyyyyy+/////////////::--..-:/+oosssssysss+osssooooooooo+//::..``  `` ````````````
                                  ``.://:://+++ooooooo+ooooosssso:.`   `.----::---..-++.                        /oooo+syyyyyo:://////::::::--...-:/+ossssyyyssooooooooooooo+///:-.` ``   `.`````````````
                                   ```.-///////++++++oo+++o++ossso:.`    `...-----.``/+:                       `+ooo+ossyyys:::::::::::---......:/+osyyyyyssoooooooooooo++++/:-```  `  ``.``````````````
                                      ```.://:::://++++++//++/ossso:`     ```......``-+/`                      -oooo+ssssss:-----------...````.:/+ssyyyyysoooo+++++o+++////:-.``````````````````````````
                                         ``.-::::-::///////:///+osso-       ```````` `/+-                     `/ssso+sssss/............``````.:/osyyyyysoo+++/++++++/////::----......``.......`````.....
``                                         ```.------::::::::-::/ooso:         `````  -+/`                    .osss+ssssso......````````````.:+oyyyyyyso++////+++//:://:---:::---......-.....``......---
``````                                        ``..-...-----------:+ooo:               `/+-          ``        -sssoosssso.````````````    `./+syyyyyso++///////:::::::--.-:---....------.......--------:
-..``````                                        ``...............-/ooo:               -o/`       -osyo:      +sss+sssss:` `````         `-/osyyyyso+//::::/::-::---.-------...--::::---..---------::::/
//::--``````                                        ```````````````./ooo:`             `++.     `+hhhhhh.    `ossoossss+`               `-/oyyyyso+/:---:::-----.```..--...--:://::---------::::::::////
o++//::--..````                                        ````   ```````-ooo/`             :o:`   `+hyssssd+    -sssosssso.               .:+syyyyo+/:-..----......````.....-://///::---------::://////////
ooooo+///::-..`````                                                   -+so/`            `++.```oddhysyhdy`  `+yysosyss:              `-/oyyyys+/:-..........````......-:/++++/:::::-------:://////:::/:/
oooooooo++//::--.`````                                                 .+oo/`           `:o:``+dddddhdddy`  .syyosyys+`             `-+syyyso+/-`````````````````..-:/+oo++/::::------::::::::::::::::::
ooooooooooo++//::--.`````                                               `/os/`           .o+./hhddyyhhhdds/`:yysoyyys.             ./oyhyys+/-`````     `  ````.-:/+ooo++/:::---------:::::---:::::---..
oooooooooooo+++++//:--..`````                                            `:os+`          `/s/yhyyhhhhhdhyhy/+yyosyys:            `-/syhyso/:.              `..-/+osso+//::--.....----------------....```
oooooooooooo++++o+++//::--.`````                                           -os+`        ``-oyyshyyhddddhyyo+yysoyys+            `:+yhhys+:.              `.-:+ossoo+/:--...............----.....````...-
++++++ooo+o++++++++++////::--..````                                         -os+`      ``..+hdddyyyhhhhhs/`:yyssyys.           ./oyhyso/-`            ``-:/ossso+/:-..``````.............``````...--::/+
////+++++++++++++++++++////::---.````                                        .+s+.    ``..-sdddddyhhhdhh/``+yyoyys:          `-/shhyo+-`            `.-/osyso+/:-.`````````````````````````..--://+++ooo
//////////+++++++++++++//////:::--..````                                      `/so.  ``...sddddmmdhddddd:`.syssyy+          `:oyhys+:.           ``-:+syyso+:-.`    ```````````````````..-:://++oooooooo
///+++++/////////////////////::::--...````                                     `:so.``..-sdddmmddhyyddyho-/yyoyys.         ./syyyo/.           `.:+oyyso+/-.`        `````````````..--:///+++ooooooo++++
+++++++++++++++///////////////::::---..````                                      -oo-`./ydddmmdyhhysddyyhooyssyy:        `.+yyyo/-`         ``-/osyso+/-.`                ````..-::///++++++++++++//////
+++++++++oooooooo+++//::::::::::::----..````                                      -oo//ohdddmh+yyhyyddydys+yoyy+        `-oyys+:`         `.:+syyo+/-.                  ```.--::////////////////////////
++++++ooooooooossssssooo+//::-------.....```                                       .os:shhhhh/yysyhshhyysyo+sys.       `/syyo:`         .-/oyyo+/-`                  ``..---::::::::::::::::::://///////
sssssssooooosssssssssssyyssso+/:---...``````                                        `+s-.--s/oyysyyshhyhysy+sy:       -+yys/.        `.:osys+/-`                   ``......-------------:::::::::----...
yyyyyyyyyyyyyyyysssyyyyyyyyyyyysso+/:-.````                                          `/s:  -ssssyyyhhhyysssoh+      `:oys+-`       `-+sys+/-`                     `````````..........-.........`````````
hhhhhhhhhhhhhhhhhhhhyyyyyyyyyyyyyyyyyso+/-.``                                          :s: `+oyyyss/+syyyyyss.     ./syo:`      `./oys+/-`                            ``````````````````````            
hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhyyyyyyyso+/-.``                                      -o:`oyhhhys`++/hhhhy+     -oys/`      `:+sso:.`                                 ``                              
hhhhhhhhhhhhhhhhhhhhddddddddddddhhhhhhhhyyyyyyysso/:-.`                                  .o/o+yhsh: ++`sshh+/   `:sy+.     `-/sso:.`                                                                    
hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhdhhhhhhhhhhyyyyyyysso+/-.`                              `+o+hyso  +/ :ssdo/  .+yo-     .:oso:.`                                                                       
hhhhhhhhhhhhhhhhhhhhhhyyyyyyyyyyyyyhhhhhhhhhhhhyyyyyyyyyysso+/:.``                         `+ohss.  +/  +shy/`:os:`   `-+o+:.`                                                                          
hhhhhhhhhhhhhhhhhhhhhhhhyyyyyyssssssooooossssssssyyyyyyyyyyyysssso/:-.`                     +shs:   +/  `osho+s+`   ./o+:.`                                                                             
hhhhhhhhhhhhhhhhhhhhhhyyyyyyyysssssooo++++////:://///++ooosssssssssssso+/-.``               /sys`   +/   .shso-  `:++:.`                                                                                
hhhhhhhhhhhhhhhhhhhhhyyyyyyyyyssssoooo+++///:::---....``...--://+ooossssssso+/:-``         `+yys    o:    oyy/`./+:.`                                                                                   
hhhhhhhhhhhhhhhhhhhhhhhhyyyyyyyssssoooo+++///::---...```        ```..-://+ooosssoo/:-.`    /oys/    o:    +sh+++-`                                                                               ```````
hhhhhhhhhhhhhhhhhhhhhhhyyyyyyysssssooo+++//::---..````                   ```..-::/++ooo+/-:+hs+     o:    `+yy+/                                                          ```````````..................-
hhhhhhhhhhhhhhhhhhhyyyyyyyyssssooo+++//::---..```                                 ```..-:/+shs:     o:     .sys+.                                                   ````....----:::::://////////////////
hhhhhhhhhhhhhhyyyyyyyysssssoooo+++///::---..````                                         `+sys.     o:     `ssys-                                                  ```....---::::::///////////++++++++oo
sshyyhhhyyyyyyyyysysssssoooo++///::--...`````                                           `.+sy+      o-      /shs:```                                               ````..---:::////+++++oooooossssssssss
yyyyyyyyyyyyssssoooo++++//:::---...```````                                     ```..-:::::+yy-      o-      `oyso+o++/::--..```````                                ````.-::::---:/+++oooooooooosssssssss
yyyssssssoooo++++///::---...-..````````                               ``..--://++//:-.``  /yy`   `.:y/.`     /ys:`.:+ossssooo++//::--..........```````               `...-:-..``.--://://++++++/:+ssssss
oooo+++/++++////::::.--::..-...````  `                      ```..-://++ooo++/:-.``       `+hy../sydddhhs+:.` .ys/    `.-/+ossssssssssoo++//:::------------------..-----.``.-:://///::::::///////:/++ooss
++++:++/++//:/-::.---..``.``.``                    ``..-:://+ooossoo+/:-.``        ......:ydhydmmmmmddddddhs+:yy+....`   ``-:+osssyyyyyyyyyysssoo++//:::----:::///++++++//+++++oooooo+oo++:+++ossssooooo
//+:/+++/-....``..``.--..`  `           ````..-://++oossssssoo+/:-.``             `shddddmmmmmmNNmNNmmmmmmmmmmmmmdddh-        `.-/+ossyyyyyyyyyyyyyyyysssoo+++//////+++ooossssssssssssssssssssssssssssss
/:+/+o+///:-::/:-:-`--.-.`````````..-::/++oossssssssssoo+/:-.`                     /hddmmmmmmmmmmmmmmmmmmmmmmmmmmmmdy`            ``.-/+ossyyyyyyyyyyyyyyyyyyyyysssssoooooooosssssyyyyyyyyyyyyyyyyyyyyss
sssssso++++/+://:-.`......-:://++oossssyyyyyysssoo+/-..`                         `.ohdmmmmmmmmmmmmmmmmmmmmmmmmmmmmmdh/.`               `.-:/+ossyyyyyyyyyyyyyyyyyyyyyyyyyyyyyssssssssyyyyyyyyyyyyyyyyyyy
ysssssoooo+////::://:/++ooosssyyyyyyyyyyyysso/:-.``                            `:sdmhmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmdddhs:.                 ``.-:/+ossyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
sssoooooooooossssssssyyyyyyyyhhhhhhyysso+/:--..```                          `.+yddmmmmmNNNNNNNNNNNNNNNNNNNNNNNNNNNNmmmmdhyo-`                  ``..-:/+osyyyhhhhhhhhyyyyyyyyyyyssssssssssssssssssyyyyyyy
sssssssssyyyyyyyyhhhhhhhhhhhhhyysoo+///::::--.````                        `:shddmddmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmdddhhy+-`                    ``.-:/+osyyhhhhhhhhhhyyyyyssssssssssssssssssssssssss
syyyyyyyyhhhhhhhhhhhhhhhyyssoo+++++++///:-..```````````````             ./ydddmmmhdmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmddNmdddhhhs:`                     ```.-/+ossyyhhhhhhhhhhhyyysssoooooooo++++oooooooo
yyyhhhhhhhhhhhhhyyyyssooooooooooo++/::--..........-.....```           .+hdddmmmNNdhmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmdhNNNmmdhhhhy+.                       ``.-:+oosyyhhhhdddhhhhhyyssooo++++++//////+++
yyyyyyyyyyyyysssssooosssssssoo++/:--......---::::::---..``         `-ohdddmmNNmNmmdmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmddNNNNmNmddhhhyo-`                      ```.-:+ossyyyhhhhdddhhhhhyyssoo+++//////:::
yyyyyysssssooossssssssssoo++/::---..---:::///////:::-..``        `:shdddmmNNNNmmmNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNmNNNNNmdhhhys/`                    `````..-:/ossyyyyhhhhhhhhhhhhyyssoo+///::::
sssssssssssssyyyssssoo++/:---------:://+++++++///::-.```       `/yhdddmmNNNMMMhdmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmdmNMMMNNNmdhhhyy+.                  ```````.--://osyyyyyyhhhhhhhhhhhyyyysoo++/:
ssssssyyyyyyysssoo+/::---------://++++ooooo+++//::-.```      .+yhdddmNNNmNNNNNhhmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmhmNNNNMMNNNmdhhyyyo:``                ``````..--://++syyyyhhhhhhhhhhhhhhyyyysso
syyyyyyyyssso++/::---------://++ooooooooooo++//:--.````````.ohhdddmNNNNMNmNNNNysdmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmdydNNNNNNNNmmmNmhhyyys/.``````          ````....---:/++++osyhhhhhhhhhhhhhhhhhyyy

Du fragst mich, ob ich mit dir komm
Du fl√ºsterst mir in mein Ohr
Du fragst mich, ob ich deine Hand nehm
Ich hab keinen Grund, dich abzulehnen

Diese Welt ist grausam
Es ist traurig aber wahr
Diese Welt ist seltsam
Es ist fraglich aber wahr
Ist der Blumengarten echt oder falsch?

*/

#ifndef ENV_HPP
#define ENV_HPP
#include <GL/gl.h>
#include <GL/glu.h>
#include <sstream>
#include <algorithm>
#include <iostream>
#include <fstream>
#include <string>
#include <vector>

bool stemOnly = false;

struct pt3{
	double x,y,z;
};

pt3 lp[11];

//leaf that has one end at plant pos
struct leaf{
	pt3 end;		//physically interactive
	pt3 lockend;	//locks spring to interactive end
	pt3 velo;
};

//tracks a number of leaves starting at a common location
struct plant{
	double x,z;
	double bound;
	std::vector<leaf> lf;
};

pt3 calcNorm(pt3 a, pt3 b){
	pt3 ret;
	ret.x = a.y*b.z-a.z*b.y;
	ret.y = a.z*b.x-a.x*b.z;
	ret.z = a.x*b.y-a.y*b.x;
	double len = sqrt(ret.x*ret.x + ret.y*ret.y + ret.z*ret.z);
	ret.x /= len;
	ret.y /= len;
	ret.z /= len;
	return ret;
}

void initLeaf(){
	lp[0].x = 0; 	lp[0].y = 0; 	lp[0].z = 0;
	lp[1].x = -0.18;lp[1].y = 0.75; lp[1].z = 0;
	lp[2].x = -0.20;lp[2].y = 1.5; 	lp[2].z = 0;
	lp[3].x = -0.05;lp[3].y = 2.25; lp[3].z = 0;
	lp[4].x = 0.25;	lp[4].y = 3; 	lp[4].z = 0;
	lp[5].x = -0.4; lp[5].y = 0.75; lp[5].z = 0.4;
	lp[6].x = -0.5; lp[6].y = 1.5; 	lp[6].z = 0.5;
	lp[7].x = -0.3; lp[7].y = 2.25; lp[7].z = 0.4;
	lp[8].x = -0.4; lp[8].y = 0.75;	lp[8].z = -0.4;
	lp[9].x = -0.5; lp[9].y = 1.5; 	lp[9].z = -0.5;
	lp[10].x = -0.3;lp[10].y = 2.25;lp[10].z = -0.4;
}

double dRand(double fMin, double fMax){
    double f=(double)rand()/RAND_MAX;
    return fMin + f*(fMax-fMin);
}

std::vector<plant> plants;
#define leaf_count 7
#define plant_rad 6
#define stem_len 1.8
#define leaf_bound 12
#define minStem 5
#define rand_bound 6

bool tooClose(double x, double y, double z, std::vector<leaf> lf, double ox, double oz){
	for(int i=0; i<lf.size(); i++){
		double dx = x - (lf[i].end.x - ox);
		double dz = z - (lf[i].end.z - oz);
		if(sqrt(dx*dx + y*y + dz*dz) < rand_bound || sqrt(x*x + y*y + z*z) < minStem){
			return true;
		}
	}
	return false;
}

void addPlant(double x, double z){
	plant plt;
	plt.x = x;
	plt.z = z;

	double maxRad = 0;
	for(int i=0; i<leaf_count; i++){
		leaf nlf;
		double nrx = dRand(-plant_rad,plant_rad);
		double nry = dRand(1,5);
		double nrz = dRand(-plant_rad,plant_rad);

		while(tooClose(nrx,nry,nrz,plt.lf,x,z)){
			nrx = dRand(-plant_rad,plant_rad);
			nry = dRand(1,5);
			nrz = dRand(-plant_rad,plant_rad);
		};

		nlf.end.x = nrx + x;
		nlf.end.y = nry;
		nlf.end.z = nrz + z;
		nlf.lockend.x = nlf.end.x;
		nlf.lockend.y = nlf.end.y;
		nlf.lockend.z = nlf.end.z;
		nlf.velo.x = 0;
		nlf.velo.y = 0;
		nlf.velo.z = 0;
		double nrad = sqrt(nrx*nrx + nry*nry + nrz*nrz);
		plt.lf.push_back(nlf);

		if(nrad > maxRad){
			maxRad = nrad;
		}
	}

	plt.bound = maxRad;
	plants.push_back(plt);
}

#define accel_mult_c 0.12
#define accel_mult_l 0.02
#define planck 0.1
#define leaf_damp 0.95
void simPlant(double cx, double cy, double cz){
	//for each plant
	//check if the character is within the bound
	//if yes for each leaf
	//check if within the leaf bound
	//if yes
	//set velo to be away from c and towards lockend accel
	//move based on velo
	double dx,dy,dz;
	for(int i=0; i<plants.size(); i++){
		dx = cx - plants[i].x;
		dz = cz - plants[i].z;

		if(sqrt(dx*dx + dz*dz) < plants[i].bound){
			for(int j=0; j<plants[i].lf.size(); j++){
				dx = plants[i].lf[j].end.x - cx;
				dy = plants[i].lf[j].end.y - cy;
				dz = plants[i].lf[j].end.z - cz;

				if(sqrt(dx*dx + dy*dy + dz*dz) < leaf_bound){
					if(abs(dx) > planck){plants[i].lf[j].velo.x += accel_mult_c * (1/dx);}
					if(abs(dy) > planck){plants[i].lf[j].velo.y += accel_mult_c * (1/dy);}
					if(abs(dz) > planck){plants[i].lf[j].velo.z += accel_mult_c * (1/dz);}
				}
			}
		}

		//std::cout << plants[i].lf[0].lockend.y << " , " << plants[i].lf[0].end.y << "\n";
		for(int j=0; j<plants[i].lf.size(); j++){
			dx = plants[i].lf[j].lockend.x - plants[i].lf[j].end.x;
			dy = plants[i].lf[j].lockend.y - plants[i].lf[j].end.y;
			dz = plants[i].lf[j].lockend.z - plants[i].lf[j].end.z;

			plants[i].lf[j].velo.x += accel_mult_l * dx;
			plants[i].lf[j].velo.y += accel_mult_l * dy;
			plants[i].lf[j].velo.z += accel_mult_l * dz;

			plants[i].lf[j].velo.x *= leaf_damp;
			plants[i].lf[j].velo.y *= leaf_damp;
			plants[i].lf[j].velo.z *= leaf_damp;

			plants[i].lf[j].end.x += plants[i].lf[j].velo.x;
			plants[i].lf[j].end.y += plants[i].lf[j].velo.y;
			plants[i].lf[j].end.z += plants[i].lf[j].velo.z;
		}
	}
}

void ccl(){
	glColor3f(0.1,0.4,0.1);
}

void ccd(){
	glColor3f(0.1,0.2,0.1);
}

void pvtx(pt3 p){
	glVertex3d(p.x,p.y,p.z);
}

double torad(double deg){
	return deg*0.01745329251;
}

double angbet(pt3 a, pt3 b){
	double dot = a.x*b.x + a.y*b.y + a.z*b.z;
	double mag = sqrt(a.x*a.x + a.y*a.y + a.z*a.z) * sqrt(b.x*b.x + b.y*b.y + b.z*b.z);
	return 57.2957795*acos(dot/mag);
}

void drawLeaf(leaf l, double ox, double oz){
	pt3 lpi[11];
	pt3 stem;
	pt3 xa; xa.x = 1; xa.y = 0; xa.z = 0;
	pt3 ya; ya.x = 0; ya.y = 1; ya.z = 0;

	//find polar angle between (x,y,z) and y axis
	stem.x = l.end.x - ox;
	stem.y = l.end.y;
	stem.z = l.end.z - oz;
	double polar = -angbet(stem, ya);

	//find azumuth angle
	stem.y = 0;
	//double azum = angbet(stem, xa);
	double azum = 57.2957795*atan2(oz - l.end.z, l.end.x - ox);

	//transform based on angles of the stem
	for(int i=0; i<11; i++){
		double pocos = cos(torad(polar));
		double posin = sin(torad(polar));

		double azcos = cos(torad(azum));
		double azsin = sin(torad(azum));

		double nx, ny, nz;
		nx = lp[i].x * pocos - lp[i].y * posin;
		ny = lp[i].x * posin + lp[i].y * pocos;
		lpi[i].y = ny;
		lpi[i].x = nx;
		lpi[i].z = lp[i].z;

		nx = lpi[i].x * azcos + lpi[i].z * azsin;
		nz = lpi[i].z * azcos - lpi[i].x * azsin;
		lpi[i].x = nx;
		lpi[i].z = nz;
	}

	//uniform scale based on stem lenght and translate
	double dx = l.end.x - ox;
	double dy = l.end.y;
	double dz = l.end.z - oz;
	double dist = sqrt(dx*dx + dy*dy + dz*dz);
	double ratio = dist/stem_len;
	for(int i=0; i<11; i++){
		lpi[i].x *= ratio; lpi[i].x += ox;
		lpi[i].y *= ratio;
		lpi[i].z *= ratio; lpi[i].z += oz;
	}

	glDisable(GL_TEXTURE_2D);
	glNormal3d(0,1,0);

	if(stemOnly){
		glBegin(GL_LINES);
	    glColor3f(1,0,0);
	    glVertex3d(ox,0,oz);
	    glVertex3d(l.end.x,l.end.y,l.end.z);
	    glEnd();
	}else{
		glBegin(GL_TRIANGLES);
	    ccd(); pvtx(lpi[0]); pvtx(lpi[1]); ccl(); pvtx(lpi[5]);
	    pvtx(lpi[8]); ccd(); pvtx(lpi[0]); pvtx(lpi[1]);
	    pvtx(lpi[3]); pvtx(lpi[4]); ccl(); pvtx(lpi[7]);
	    pvtx(lpi[10]); ccd(); pvtx(lpi[3]); pvtx(lpi[4]);
	    glEnd();

	    glBegin(GL_QUADS);
	    pvtx(lpi[1]); pvtx(lpi[2]); ccl(); pvtx(lpi[6]); pvtx(lpi[5]);
	    pvtx(lpi[8]); pvtx(lpi[9]); ccd(); pvtx(lpi[2]); pvtx(lpi[1]);
	    pvtx(lpi[2]); pvtx(lpi[3]); ccl(); pvtx(lpi[7]); pvtx(lpi[6]);
	    pvtx(lpi[9]); pvtx(lpi[10]); ccd(); pvtx(lpi[3]); pvtx(lpi[2]);
	    glEnd();

	    for(int i=0; i<11; i++){
			lpi[i].y = -lpi[i].y;
		}

		glBegin(GL_TRIANGLES);
	    ccd(); pvtx(lpi[0]); pvtx(lpi[1]); ccl(); pvtx(lpi[5]);
	    pvtx(lpi[8]); ccd(); pvtx(lpi[0]); pvtx(lpi[1]);
	    if(lpi[4].y < 0){
		    pvtx(lpi[3]); pvtx(lpi[4]); ccl(); pvtx(lpi[7]);
		    pvtx(lpi[10]); ccd(); pvtx(lpi[3]); pvtx(lpi[4]);
		}
	    glEnd();

	    glBegin(GL_QUADS);
	    pvtx(lpi[1]); pvtx(lpi[2]); ccl(); pvtx(lpi[6]); pvtx(lpi[5]);
	    pvtx(lpi[8]); pvtx(lpi[9]); ccd(); pvtx(lpi[2]); pvtx(lpi[1]);
	    pvtx(lpi[2]); pvtx(lpi[3]); ccl(); pvtx(lpi[7]); pvtx(lpi[6]);
	    pvtx(lpi[9]); pvtx(lpi[10]); ccd(); pvtx(lpi[3]); pvtx(lpi[2]);
	    glEnd();
	}
}

void drawPlants(){
	for(int i=0; i<plants.size(); i++){
		plant plt = plants[i];
		for(int j=0; j<plt.lf.size(); j++){
			drawLeaf(plt.lf[j], plt.x, plt.z);
		}
		/*glBegin(GL_TRIANGLE_FAN);
    	glColor4f(0,0,0,0.5);
    	glVertex3d(plt.x,0.05,plt.z);
    	glColor4f(0,0,0,0);
    	glVertex3d(plt.x+5,0.2,plt.z);
    	glVertex3d(plt.x+5,0.2,plt.z+5);
    	glVertex3d(plt.x,0.2,plt.z+5);
    	glVertex3d(plt.x-5,0.2,plt.z+5);
    	glVertex3d(plt.x-5,0.2,plt.z);
    	glVertex3d(plt.x-5,0.2,plt.z-5);
    	glVertex3d(plt.x,0.2,plt.z-5);
    	glVertex3d(plt.x+5,0.2,plt.z-5);
    	glVertex3d(plt.x+5,0.2,plt.z);
    	glEnd();*/
	}
}

struct pcloth{
	bool locked;
	double x,y,z;
	double vx,vy,vz;
	pt3 n;
};

struct pcon{
	int ai, aj;
	int bi, bj;
};

#define cloth_initx 10
#define cloth_inity 28
#define cloth_initz -10
#define cloth_width 21
#define cloth_height 20
#define cloth_rad 3

#define cloth_grav 0.012
#define cloth_mult 0.4
#define cloth_damp 0.97
#define cloth_stretch 0.9
#define cloth_accel 3

pcloth cloth[cloth_width][cloth_height];
pcon pcons[(cloth_width-1)*(cloth_height)+(cloth_width)*(cloth_height-1)];

//create grid of cloth
void initCloth(){
	for(int i=0; i<cloth_width; i++){
		for(int j=0; j<cloth_height; j++){
			cloth[i][j].x = cloth_initx + i;
			cloth[i][j].y = cloth_inity - j;
			cloth[i][j].z = cloth_initz;
			cloth[i][j].vx = 0;
			cloth[i][j].vy = 0;
			cloth[i][j].vz = 0;
			cloth[i][j].locked = false;
		}
	}

	int pconid = 0;
	for(int i=0; i<cloth_width-1; i++){
		for(int j=0; j<cloth_height; j++){
			pcons[pconid].ai = i;
			pcons[pconid].aj = j;
			pcons[pconid].bi = i+1;
			pcons[pconid].bj = j;
			pconid++;
		}
	}

	for(int i=0; i<cloth_width; i++){
		for(int j=0; j<cloth_height-1; j++){
			pcons[pconid].ai = i;
			pcons[pconid].aj = j;
			pcons[pconid].bi = i;
			pcons[pconid].bj = j+1;
			pconid++;
		}
	}

	cloth[0][0].locked = true;
	cloth[5][0].locked = true;
	cloth[10][0].locked = true;
	cloth[15][0].locked = true;
	cloth[20][0].locked = true;
}

//use pcons and take in distance, and accelerate towards side and upper ones
void simThread(int ai, int aj, int bi, int bj){
	//get distance from diffs
	pcloth pca = cloth[ai][aj];
	pcloth pcb = cloth[bi][bj];
	double dx = pca.x - pcb.x;
	double dy = pca.y - pcb.y;
	double dz = pca.z - pcb.z;
	double dist = sqrt(dx*dx + dy*dy + dz*dz);

	//get diff from stretch
	if(dist > cloth_stretch){
		double dacl = dist - cloth_stretch;
		//accelerate based on normalize vector if it's not locked
		dx /= dist;
		dy /= dist;
		dz /= dist;

		dx *= dacl;
		dy *= dacl;
		dz *= dacl;

		if(!pcb.locked){
			cloth[bi][bj].vx += cloth_mult * dx;
			cloth[bi][bj].vy += cloth_mult * dy;
			cloth[bi][bj].vz += cloth_mult * dz;
		}

		if(!pca.locked){
			cloth[ai][aj].vx -= cloth_mult * dx;
			cloth[ai][aj].vy -= cloth_mult * dy;
			cloth[ai][aj].vz -= cloth_mult * dz;
		}
	}
}

pt3 clNorm(pt3 a, pt3 b){
	pt3 ret;
	ret.x = a.y*b.z-a.z*b.y;
	ret.y = a.z*b.x-a.x*b.z;
	ret.z = a.x*b.y-a.y*b.x;
	double len = sqrt(ret.x*ret.x + ret.y*ret.y + ret.z*ret.z);
	ret.x /= len;
	ret.y /= len;
	ret.z /= len;
	return ret;
}

//physics
//take in player model info and accelerate away
//accelerate towards ground
//update and use velo
void simCloth(double cx, double cy, double cz){
	int pcc = (cloth_width-1)*(cloth_height)+(cloth_width)*(cloth_height-1);
	for(int i=0; i<pcc; i++){
		simThread(pcons[i].ai, pcons[i].aj, pcons[i].bi, pcons[i].bj);
	}

	for(int i=0; i<cloth_width; i++){
		for(int j=0; j<cloth_height; j++){
			if(!cloth[i][j].locked){
				double dx = cloth[i][j].x - cx;
				double dy = cloth[i][j].y - cy;
				double dz = cloth[i][j].z - cz;
				double dist = sqrt(dx*dx + dy*dy + dz*dz);
				dx /= dist;
				dy /= dist;
				dz /= dist;
				if(dist < cloth_rad){
					cloth[i][j].vx += cloth_accel * (dx/(dist+1));
					cloth[i][j].vy += cloth_accel * (dy/(dist+1));
					cloth[i][j].vz += cloth_accel * (dz/(dist+1));
				}
			}
		}
	}

	for(int i=0; i<cloth_width; i++){
		for(int j=0; j<cloth_height; j++){
			if(!cloth[i][j].locked){
				cloth[i][j].vy -= cloth_grav;

				cloth[i][j].vx *= cloth_damp;
				cloth[i][j].vy *= cloth_damp;
				cloth[i][j].vz *= cloth_damp;

				cloth[i][j].x += cloth[i][j].vx;
				cloth[i][j].y += cloth[i][j].vy;
				cloth[i][j].z += cloth[i][j].vz;
			}
		}
	}

	for(int i=1; i<cloth_width-1; i++){
		for(int j=1; j<cloth_height-1; j++){
			/*vct a,b;
			a.x = 2;
			a.y = (columns[i+1][j].v + columns[i+1][j].sv) - (columns[i-1][j].v + columns[i-1][j].sv);
			a.z = 0;

			b.x = 0;
			b.y = (columns[i][j+1].v + columns[i][j+1].sv) - (columns[i][j-1].v + columns[i][j-1].sv);
			b.z = 2;

			columns[i][j].norm = calcNorm(b,a);*/
			pcloth cleft = cloth[i-1][j];
			pcloth cright = cloth[i+1][j];
			pcloth cup = cloth[i][j-1];
			pcloth cdown = cloth[i][j+1];

			pt3 a,b;
			a.x = cright.x - cleft.x;
			a.y = cright.y - cleft.y;
			a.z = cright.z - cleft.z;

			b.x = cdown.x - cup.x;
			b.y = cdown.y - cup.y;
			b.z = cdown.z - cup.z;

			cloth[i][j].n = clNorm(b,a);
		}
	}
}

bool wireCloth = false;

//renderer
void drawCloth(){
	glDisable(GL_TEXTURE_2D);
	glNormal3d(0,1,0);
	glColor3f(0.5,0,0);
	if(wireCloth){
		glBegin(GL_LINES);
		for(int i=0; i<cloth_width-1; i++){
			for(int j=0; j<cloth_height-1; j++){
				pcloth cpt1 = cloth[i][j];
				pcloth cpt2 = cloth[i+1][j];
				pcloth cpt3 = cloth[i+1][j+1];
				pcloth cpt4 = cloth[i][j+1];
				glNormal3d(cpt1.n.x,cpt1.n.y,cpt1.n.z); glVertex3d(cpt1.x,cpt1.y,cpt1.z);
				glNormal3d(cpt2.n.x,cpt2.n.y,cpt2.n.z); glVertex3d(cpt2.x,cpt2.y,cpt2.z);
				glNormal3d(cpt2.n.x,cpt2.n.y,cpt2.n.z); glVertex3d(cpt2.x,cpt2.y,cpt2.z);
				glNormal3d(cpt3.n.x,cpt3.n.y,cpt3.n.z); glVertex3d(cpt3.x,cpt3.y,cpt3.z);
				glNormal3d(cpt3.n.x,cpt3.n.y,cpt3.n.z); glVertex3d(cpt3.x,cpt3.y,cpt3.z);
				glNormal3d(cpt4.n.x,cpt4.n.y,cpt4.n.z); glVertex3d(cpt4.x,cpt4.y,cpt4.z);
				glNormal3d(cpt4.n.x,cpt4.n.y,cpt4.n.z); glVertex3d(cpt4.x,cpt4.y,cpt4.z);
				glNormal3d(cpt1.n.x,cpt1.n.y,cpt1.n.z); glVertex3d(cpt1.x,cpt1.y,cpt1.z);
			}
		}
		glEnd();
	}else{
		glBegin(GL_QUADS);
		for(int i=0; i<cloth_width-1; i++){
			for(int j=0; j<cloth_height-1; j++){
				pcloth cpt1 = cloth[i][j];
				pcloth cpt2 = cloth[i+1][j];
				pcloth cpt3 = cloth[i+1][j+1];
				pcloth cpt4 = cloth[i][j+1];
				glNormal3d(cpt1.n.x,cpt1.n.y,cpt1.n.z); glVertex3d(cpt1.x,cpt1.y,cpt1.z);
				glNormal3d(cpt2.n.x,cpt2.n.y,cpt2.n.z); glVertex3d(cpt2.x,cpt2.y,cpt2.z);
				glNormal3d(cpt3.n.x,cpt3.n.y,cpt3.n.z); glVertex3d(cpt3.x,cpt3.y,cpt3.z);
				glNormal3d(cpt4.n.x,cpt4.n.y,cpt4.n.z); glVertex3d(cpt4.x,cpt4.y,cpt4.z);
			}
		}
		glEnd();
	}
}

#endif